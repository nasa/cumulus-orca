<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-developer/development-guide/code/integration-tests" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.6.0">
<title data-rh="true">Integration Tests | Operational Recovery Cloud Archive (ORCA)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nasa.github.io/cumulus-orca/docs/developer/development-guide/code/integration-tests"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Integration Tests | Operational Recovery Cloud Archive (ORCA)"><meta data-rh="true" name="description" content="Instructions on Developing and Running Integration Tests"><meta data-rh="true" property="og:description" content="Instructions on Developing and Running Integration Tests"><link data-rh="true" rel="icon" href="/cumulus-orca/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://nasa.github.io/cumulus-orca/docs/developer/development-guide/code/integration-tests"><link data-rh="true" rel="alternate" href="https://nasa.github.io/cumulus-orca/docs/developer/development-guide/code/integration-tests" hreflang="en"><link data-rh="true" rel="alternate" href="https://nasa.github.io/cumulus-orca/docs/developer/development-guide/code/integration-tests" hreflang="x-default"><link rel="stylesheet" href="/cumulus-orca/assets/css/styles.36534ff5.css">
<script src="/cumulus-orca/assets/js/runtime~main.4d62db1b.js" defer="defer"></script>
<script src="/cumulus-orca/assets/js/main.ca73b07f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cumulus-orca/"><div class="navbar__logo"><img src="/cumulus-orca/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/cumulus-orca/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Operational Recovery Cloud Archive (ORCA)</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cumulus-orca/docs/developer/quickstart/developer-intro">Developer Guide</a><a class="navbar__item navbar__link" href="/cumulus-orca/docs/operator/operator-intro">Operator Guide</a><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cumulus-orca/docs/developer/quickstart/developer-intro">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/cumulus-orca/docs/developer/development-guide/code/contrib-code-intro">Development Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/contrib-code-intro">Developing Code</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/contrib-code-intro">Code Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/setup-dev-env">Setting Up a Dev Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/best-practices">Best Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/clean-architecture">Clean Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/versioning-releases">ORCA Versioning and Releases</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/linting">Running Pylint Against Your Code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/local-debugging">Local Debugging with AWS Resources</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/unit-tests">Unit Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/integration-tests">Integration Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/postgres-tests">Postgres Tests</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/orca-logging">ORCA Logs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/parallel-scripting">Parallel Scripting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/code/postgres-tips">Postgres Paging</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/cumulus-orca/docs/developer/development-guide/documentation/contrib-documentation-intro">Developing Documentation</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cumulus-orca/docs/developer/deployment-guide/deployment">Deployment Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cumulus-orca/docs/developer/api">API Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/cumulus-orca/docs/developer/research/research-intro">Research</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cumulus-orca/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Development Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developing Code</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Integration Tests</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Integration Tests</h1></header><p>While <a href="/cumulus-orca/docs/developer/development-guide/code/unit-tests">unit tests</a> cover individual functions, this does not constitute full coverage.
Consideration should be given to how the components of a large system interact, and how the layers fit together.
These tests run realistic scenarios against a full system via scripts run in Bamboo.</p>
<ul>
<li><a href="#structure">File Structure</a></li>
<li><a href="#running">Running Tests</a></li>
</ul>
<a name="structure"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="file-structure">File Structure<a href="#file-structure" class="hash-link" aria-label="Direct link to File Structure" title="Direct link to File Structure">​</a></h2>
<p>Tests are grouped into modules under the <code>test_packages</code> folder.
When adding a test group:</p>
<ol>
<li>Create a new directory under <code>test_packages</code>, named appropriately for your new group.</li>
<li>Copy the <code>__init__.py</code> from another group into your group.</li>
<li>Modify the <code>workflow_tests/__init__.py</code>, adding your new group to the list of imports.</li>
<li>You may now begin adding test files to your new directory.
Note that each filename should begin with the <code>test</code> prefix, and should contain a class of the format <code>class TestDescriptiveName(TestCase):</code></li>
</ol>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>As tests are run in parallel, it is generally good practice to have one test-per-file, to avoid any shared setup.</p></div></div>
<a name="running"></a>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-tests">Running Tests<a href="#running-tests" class="hash-link" aria-label="Direct link to Running Tests" title="Direct link to Running Tests">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-locally">Running Locally<a href="#running-locally" class="hash-link" aria-label="Direct link to Running Locally" title="Direct link to Running Locally">​</a></h3>
<ol>
<li>
<p><a href="https://nasa.github.io/cumulus-orca/docs/developer/deployment-guide/deployment" target="_blank" rel="noopener noreferrer">Deploy ORCA to AWS</a>.</p>
</li>
<li>
<p>Connect to the NASA vpn.</p>
</li>
<li>
<p>Set the following environment variables:</p>
<ol>
<li><code>orca_API_DEPLOYMENT_INVOKE_URL</code> Output from the ORCA TF module. ex: <code>https://0000000000.execute-api.us-west-2.amazonaws.com</code></li>
<li><code>orca_RECOVERY_STEP_FUNCTION_ARN</code> ARN of the recovery step function. ex: <code>arn:aws:states:us-west-2:000000000000:stateMachine:PREFIX-OrcaRecoveryWorkflow</code></li>
<li><code>orca_COPY_TO_ARCHIVE_STEP_FUNCTION_ARN</code> ARN of the copy_to_archive step function. ex: <code>arn:aws:states:us-west-2:000000000000:stateMachine:PREFIX-OrcaCopyToArchiveWorkflow</code></li>
<li><code>orca_INTERNAL_RECONCILIATION_STEP_FUNCTION_ARN</code> ARN of the get_current_archive_list and perform_orca_reconcile step function. ex: <code>arn:aws:states:us-west-2:000000000000:stateMachine:PREFIX-OrcaInternalReconciliationWorkflow</code></li>
<li><code>orca_INTERNAL_REPORT_SQS_URL</code> URL of the internal_report SQS queue. ex:<code>https://sqs.us-west-2.amazonaws.com/000000000000/PREFIX-orca-internal-report-queue.fifo</code></li>
<li><code>orca_RECOVERY_BUCKET_NAME</code> S3 bucket name where the recovered files will be archived. ex: <code>test-orca-primary</code></li>
<li><code>orca_REPORTS_BUCKET_NAME</code> S3 bucket name of the ORCA reports bucket. ex: <code>test-orca-reports</code></li>
<li><code>orca_BUCKETS</code>The list of ORCA buckets used. ex:</li>
</ol>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;{&quot;protected&quot;: {&quot;name&quot;: &quot;&#x27;$PREFIX&#x27;-protected&quot;, &quot;type&quot;: &quot;protected&quot;}, &quot;internal&quot;: {&quot;name&quot;: &quot;&#x27;$PREFIX&#x27;-internal&quot;, &quot;type&quot;: &quot;internal&quot;}, &quot;private&quot;: {&quot;name&quot;: &quot;&#x27;$PREFIX&#x27;-private&quot;, &quot;type&quot;: &quot;private&quot;}, &quot;public&quot;: {&quot;name&quot;: &quot;&#x27;$PREFIX&#x27;-public&quot;, &quot;type&quot;: &quot;public&quot;}, &quot;orca_default&quot;: {&quot;name&quot;: &quot;&#x27;$PREFIX&#x27;-orca-primary&quot;, &quot;type&quot;: &quot;orca&quot;}, &quot;provider&quot;: {&quot;name&quot;: &quot;orca-sandbox-s3-provider&quot;, &quot;type&quot;: &quot;provider&quot;}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Get your Cumulus EC2 instance ID using the following AWS CLI command using your <code>&lt;PREFIX&gt;</code>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">aws ec2 describe-instances --filters Name=instance-state-name,Values=running Name=tag:Name,Values={PREFIX}-CumulusECSCluster --query &quot;Reservations[*].Instances[*].InstanceId&quot; --output text</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then run the following bash command,
replacing <code>i-00000000000000000</code> with your <code>PREFIX-CumulusECSCluster</code> ec2 instance ID,
and <code>0000000000.execute-api.us-west-2.amazonaws.com</code> with your API Gateway identifier:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">aws ssm start-session --target i-00000000000000000 --document-name AWS-StartPortForwardingSessionToRemoteHost --parameters &#x27;{&quot;host&quot;:[&quot;0000000000.execute-api.us-west-2.amazonaws.com&quot;],&quot;portNumber&quot;:[&quot;443&quot;], &quot;localPortNumber&quot;:[&quot;8000&quot;]}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>In the root folder <code>workflow_tests</code>, run the following command:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">bin/run_tests.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="running-in-bamboo">Running in Bamboo<a href="#running-in-bamboo" class="hash-link" aria-label="Direct link to Running in Bamboo" title="Direct link to Running in Bamboo">​</a></h3>
<p><a href="https://bugs.earthdata.nasa.gov/browse/ORCA-96" target="_blank" rel="noopener noreferrer">Not yet developed.</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="test-assumptions">Test Assumptions<a href="#test-assumptions" class="hash-link" aria-label="Direct link to Test Assumptions" title="Direct link to Test Assumptions">​</a></h2>
<p>These are suggestions for rules and setup procedures for integration tests.
Documentation below assumes that the following are applied.</p>
<ul>
<li>Values should be randomized whenever possible.
This will avoid copy-pasted strings causing false-positives.
Only reuse resources when creating resources for each test would be problematic.</li>
<li>The higher the level, the higher the priority.
For example, testing a step function can theoretically cover the relevant lambdas along with their integration into the step function.
Note that this does not fully cover the functionality of the individual components. Full run-through paths for each functionality of each component may be prohibitively time intensive both in terms of coding and test runtime, but should be considered.</li>
<li>Smaller integration tests are better suited for narrowing in on errors, and should be considered for any new feature&#x27;s <a href="#happy-path">happy path</a>.</li>
<li>Due to automated processes and network latency, some operations may take time.
Build retries with timeouts into network calls when appropriate.</li>
<li>Since tests may take some time, test multiple values at once.
For example, if testing a flow where different file extensions are treated differently, pass multiple types into the flow and make sure they are handled properly.</li>
<li>A persistent data bucket should exist to provide files for ingest.</li>
<li>Tests should be run in parallel when possible.</li>
<li>Use realistic routes when feasible. For example, ingest files to Orca instead of placing them in the bucket manually.</li>
<li>All resources, including storage mediums, should be deleted after all tests have been run.<!-- -->
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>When deleted, KMS keys persist for a minimum of 7 days. In order to run tests more often
than every 7-8 days, a randomized prefix could be used for   deployment to avoid collision
errors with KMS key names within the same environment.</p></div></div>
</li>
<li>Initially, automated validation will not include checking Cloudwatch logs. Logs will be available for 7 days to help manually identify any errors and troubleshoot problems. In the future, automating searches for key phrases in Cloudwatch logs as validation may be used for identifying point-of-failure in processes.</li>
<li>Integration tests should be run on a regular cadence. Initial suggestion is once every 1-2 weeks.</li>
<li>Ingest test assumes that for the large 191GB file testing, the file is already present in the source bucket. This is because uploading the file to source bucket will take long time and delay integration test.</li>
<li>Ingest tests only work if the catalog is cleaned between runs. Make sure to remove the recovered files from your orca recovery bucket as well as catalog after running the tests.</li>
</ul>
<p>Some broad categories of tests are shown below.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="happy-path">Happy Path<a href="#happy-path" class="hash-link" aria-label="Direct link to Happy Path" title="Direct link to Happy Path">​</a></h3>
<p>These are basic tests that perform a full run-through of a feature.
Randomized data is used to create a valid state, and a valid user is used to trigger/retrieve work.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="security-paths">Security Paths<a href="#security-paths" class="hash-link" aria-label="Direct link to Security Paths" title="Direct link to Security Paths">​</a></h3>
<p>If feasible, there should be a copy of each <a href="#happy-path">Happy Path</a> test that checks the same route, but with one property modified so as to fail security checks.
For lambdas with properly specified permissions, this will involve calling the lambda with a user that does not have permission to invoke the lambda.
For components such as databases and S3 buckets, this will involve attempting to retrieve/delete/add data with a user that does not have the appropriate permissions.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>To improve maintainability, use a shared function for setup of the <a href="#happy-path">Happy Path</a> and Security Path tests for a given component.</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Due to how NGAP handles security, even resources with public access enabled cannot be accessed publicly.
Further research should be done to identify how to perform these tests.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="error-paths">Error Paths<a href="#error-paths" class="hash-link" aria-label="Direct link to Error Paths" title="Direct link to Error Paths">​</a></h3>
<p>These tests verify that when an error is expected, a proper error is returned/raised.
For example, several entries in our <a href="https://nasa.github.io/cumulus-orca/docs/developer/api" target="_blank" rel="noopener noreferrer">API</a> should properly return a 404 error code if the entry does not exist in the database.
The test should fail if the API returns the error in a dictionary instead of an HTTP status code, or the API returns any other error code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-not-to-test">What Not to Test<a href="#what-not-to-test" class="hash-link" aria-label="Direct link to What Not to Test" title="Direct link to What Not to Test">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-integrations">External Integrations<a href="#external-integrations" class="hash-link" aria-label="Direct link to External Integrations" title="Direct link to External Integrations">​</a></h3>
<p>We do not presently test integrations with Cumulus or other external consumers.
As we do not want to deepen coupling with Cumulus, it is best to focus on maintaining a consistent API.</p>
<p>Manual tests should still be run with Cumulus to check for changes in Cumulus output/input schemas, Orca input/output schemas, Cumulus Message Adapter, and the Cumulus Dashboard. These manual tests should replicate the ingest/recovery tests.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h3>
<p>While there is a desire to eventually develop performance tests, these tests should focus on functionality with generous timeouts.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="needed-tests">Needed Tests<a href="#needed-tests" class="hash-link" aria-label="Direct link to Needed Tests" title="Direct link to Needed Tests">​</a></h2>
<p>This is a list of tests that should be created for existing Orca architecture. This list may change as tests are created and components are modified.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="internal-reconciliation"><a href="https://nasa.github.io/cumulus-orca/docs/developer/research/research-reconciliation" target="_blank" rel="noopener noreferrer">Internal Reconciliation</a><a href="#internal-reconciliation" class="hash-link" aria-label="Direct link to internal-reconciliation" title="Direct link to internal-reconciliation">​</a></h3>
<ul>
<li><a href="#happy-path">Happy</a>:<!-- -->
<ol>
<li>Ingest randomized data to Orca.</li>
<li>Modify the catalog and post S3 data in the structure of an S3 inventory report to the report bucket. Include at least one of each error type comparing between the two sources.<!-- -->
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>While we could wait for the automated S3 Inventory report to generate, this could take up to 24 hours, which would delay testing.
Therefore, use a dummy report that matches the AWS report schema to perform automated testing.
Prior to release or periodically, an S3 Inventory report should be generated through AWS mechanisms to validate the schema and style of the test report being used.</p></div></div>
</li>
<li>Post a mocked-up manifest to the report bucket.</li>
<li>Retry calls to the <a href="https://nasa.github.io/cumulus-orca/docs/developer/api#internal-reconcile-report-jobs-api" target="_blank" rel="noopener noreferrer">Internal Reconcile Report API</a> until job is complete.</li>
<li>Check that job is successful, and expected errors can be retrieved through the API.<!-- -->
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If the catalog is not reset prior to this test, or other tests run in parallel, other errors may be present.
Make sure none of these errors contain your randomized keys.</p></div></div>
</li>
</ol>
</li>
<li><a href="#security-paths">Security</a>:<!-- -->
<ol>
<li>Follow the Happy test up to contacting the API.</li>
<li>No internal reconciliation endpoints should be publicly accessible, even if the job-id is known.</li>
</ol>
</li>
<li><a href="#error-paths">Error</a>:<!-- -->
<ol>
<li>Requests for a non-existent job and its reports should return HTTP Status 404.</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ingest">Ingest<a href="#ingest" class="hash-link" aria-label="Direct link to Ingest" title="Direct link to Ingest">​</a></h3>
<ul>
<li><a href="#happy-path">Happy</a>:<!-- -->
<ol>
<li>Add files to an S3 bucket that is registered with Orca.
Structure should imitate multiple granules.<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Include a large (bigger than 250 Gb) file to make sure timeouts do not prevent ingest.</p></div></div>
</li>
<li>Call the OrcaCopyToArchiveWorkflow to ingest the granules to Orca.<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure to cover excludedFileExtensions being set, being unset, and excluding/allowing proper files in either case.
May require additional tests.</p></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Future work will allow us to target multiple buckets with ingest.</p></div></div>
</li>
<li>Check the StepFunction status until status is completed.</li>
<li>Call the <a href="https://nasa.github.io/cumulus-orca/docs/developer/api#catalog-reporting-api" target="_blank" rel="noopener noreferrer">Catalog API</a> to make sure entries are found.</li>
<li>Verify that the files are present in the proper Orca bucket.</li>
</ol>
</li>
<li><a href="#security-paths">Security</a>:<!-- -->
<ol>
<li>Follow the Happy test up to calling the workflow.</li>
<li>Workflow should not be publicly accessible, even if files are valid.</li>
<li>Follow the Happy test up to contacting the API.</li>
<li>No catalog endpoints should be publicly accessible, even if the granule-id or other values are known.</li>
</ol>
</li>
<li><a href="#error-paths">Error</a>:<!-- -->
<ol>
<li>
<p>Requests for catalog info on a non-existent granule/file should return HTTP Status 404.</p>
</li>
<li>
<p>Attempting to ingest a file that does not exist should result in <code>files does not exist</code>.</p>
</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="recovery">Recovery<a href="#recovery" class="hash-link" aria-label="Direct link to Recovery" title="Direct link to Recovery">​</a></h3>
<ul>
<li>
<p><a href="#happy-path">Happy</a>:</p>
<ol>
<li>Ingest randomized data to Orca.<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Include a large (bigger than 250 Gb) file to make sure timeouts do not prevent recovery.</p></div></div>
</li>
<li>Call the OrcaRecoveryWorkflow to restore the files from Orca to another bucket.<!-- -->
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Make sure to cover excludedFileExtensions being set, being unset, and excluding/allowing proper files in either case.
May require additional tests.
Ignored files will not be listed in output.</p></div></div>
</li>
<li>Retry calls to the <a href="https://nasa.github.io/cumulus-orca/docs/developer/api#recovery-granules-api" target="_blank" rel="noopener noreferrer">Recovery Granules API</a> until entries are found, and status is <code>complete</code>.<!-- -->
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Recovery may take up to 4 hours.</p></div></div>
</li>
<li>Verify that the files are present in the proper target bucket.</li>
</ol>
</li>
<li>
<p><a href="#security-paths">Security</a>:</p>
<ol>
<li>Follow the Happy test up to contacting the API.</li>
<li>No recovery endpoints should be publicly accessible, even if the granule-id or other values are known.</li>
</ol>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>The following test will only be valid after completing <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-351" target="_blank" rel="noopener noreferrer">ORCA-351</a>.</p></div></div>
<ol>
<li>Follow the Happy test up to calling the workflow.</li>
<li>Workflow should not be publicly accessible, even if files are valid.</li>
<li>Follow the Happy test up to calling the workflow.</li>
<li>Workflow should not be able to restore files to arbitrary buckets that Orca does not have permission to write to.</li>
</ol>
</li>
<li>
<p><a href="#error-paths">Error</a>:</p>
<ol>
<li>
<p>Requests for recovery info on files that are not being recovered should return HTTP Status 404.</p>
</li>
<li>
<p>Recovering files that are in the process of being recovered should return an error.</p>
</li>
<li>
<p>Attempting to recover a file that does not exist should result in <code>files does not exist</code>.</p>
</li>
</ol>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="general-security">General Security<a href="#general-security" class="hash-link" aria-label="Direct link to General Security" title="Direct link to General Security">​</a></h3>
<p>All Orca resources should be private, baring specific exceptions carved out for customer integration.
Tests should be created that check for errors when contacting resources from a public perspective.
This applies to, among others:</p>
<ul>
<li>S3 Buckets</li>
<li>Lambdas</li>
<li>Databases</li>
<li>Step Functions</li>
<li>SQS Queues</li>
<li>Secret Managers</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>Some of the above may be covered by other tests.</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/development-guide/code/integration-tests.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cumulus-orca/docs/developer/development-guide/code/unit-tests"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Unit Tests</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cumulus-orca/docs/developer/development-guide/code/postgres-tests"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Postgres Tests</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#file-structure" class="table-of-contents__link toc-highlight">File Structure</a></li><li><a href="#running-tests" class="table-of-contents__link toc-highlight">Running Tests</a><ul><li><a href="#running-locally" class="table-of-contents__link toc-highlight">Running Locally</a></li><li><a href="#running-in-bamboo" class="table-of-contents__link toc-highlight">Running in Bamboo</a></li></ul></li><li><a href="#test-assumptions" class="table-of-contents__link toc-highlight">Test Assumptions</a><ul><li><a href="#happy-path" class="table-of-contents__link toc-highlight">Happy Path</a></li><li><a href="#security-paths" class="table-of-contents__link toc-highlight">Security Paths</a></li><li><a href="#error-paths" class="table-of-contents__link toc-highlight">Error Paths</a></li></ul></li><li><a href="#what-not-to-test" class="table-of-contents__link toc-highlight">What Not to Test</a><ul><li><a href="#external-integrations" class="table-of-contents__link toc-highlight">External Integrations</a></li><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li></ul></li><li><a href="#needed-tests" class="table-of-contents__link toc-highlight">Needed Tests</a><ul><li><a href="#internal-reconciliation" class="table-of-contents__link toc-highlight">Internal Reconciliation</a></li><li><a href="#ingest" class="table-of-contents__link toc-highlight">Ingest</a></li><li><a href="#recovery" class="table-of-contents__link toc-highlight">Recovery</a></li><li><a href="#general-security" class="table-of-contents__link toc-highlight">General Security</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/developer/quickstart/developer-intro">ORCA Developer Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/operator/operator-intro">ORCA Operator Guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/ORCA+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">ORCA Working Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/nasa/cumulus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Project<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cumulus+Integrators+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Integrator Working Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cumulus+Operator+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Operator Working Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://nasa.github.io/cumulus/docs/cumulus-docs-readme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>
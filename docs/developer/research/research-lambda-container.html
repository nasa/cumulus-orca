<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/research/research-lambda-container" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">Using Lambda functions as container research Notes | Operational Recovery Cloud Archive (ORCA)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://nasa.github.io/cumulus-orca/docs/developer/research/research-lambda-container"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Using Lambda functions as container research Notes | Operational Recovery Cloud Archive (ORCA)"><meta data-rh="true" name="description" content="Research Notes on Containerizing Lambdas"><meta data-rh="true" property="og:description" content="Research Notes on Containerizing Lambdas"><link data-rh="true" rel="icon" href="/cumulus-orca/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://nasa.github.io/cumulus-orca/docs/developer/research/research-lambda-container"><link data-rh="true" rel="alternate" href="https://nasa.github.io/cumulus-orca/docs/developer/research/research-lambda-container" hreflang="en"><link data-rh="true" rel="alternate" href="https://nasa.github.io/cumulus-orca/docs/developer/research/research-lambda-container" hreflang="x-default"><link rel="stylesheet" href="/cumulus-orca/assets/css/styles.d9d340c6.css">
<link rel="preload" href="/cumulus-orca/assets/js/runtime~main.db236747.js" as="script">
<link rel="preload" href="/cumulus-orca/assets/js/main.12f41519.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cumulus-orca/"><div class="navbar__logo"><img src="/cumulus-orca/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/cumulus-orca/img/cumulus-orca-logo.svg" alt="ORCA site logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Operational Recovery Cloud Archive (ORCA)</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cumulus-orca/docs/developer/quickstart/developer-intro">Developer Guide</a><a class="navbar__item navbar__link" href="/cumulus-orca/docs/operator/operator-intro">Operator Guide</a><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cumulus-orca/docs/developer/quickstart/developer-intro">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cumulus-orca/docs/developer/development-guide/code/contrib-code-intro">Development Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cumulus-orca/docs/developer/deployment-guide/deployment">Deployment Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cumulus-orca/docs/developer/api">API Reference</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/cumulus-orca/docs/developer/research/research-intro">Research</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-intro">Introduction to ORCA Research</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-localstack">Localstack Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-APIGateway">API Gateway Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-reconciliation">ORCA Reconciliation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-AuroraServerless">Aurora Serverless Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-graphql">GraphQL Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-multipart-chunksize">Multipart Chunksize Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-bamboo">Bamboo specs Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-orca-delete-functionality">Research Notes on ORCA delete functionality.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-bamboo-integration-tests">Research Notes on running integration tests in bamboo CI/CD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cumulus-orca/docs/developer/research/research-lambda-container">Using Lambda functions as container research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-pushing-docker-image">Notes on pushing and deploying docker images.</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-s3-bucket-best-practices">S3 Future Direction/Best Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-deep-archive-migration">Deep Archive Storage Migration Research Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cumulus-orca/docs/developer/research/research-logging-libraries">Logging Libraries Research Notes</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cumulus-orca/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Research</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Using Lambda functions as container research Notes</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Using Lambda functions as container research Notes</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>Lambda functions can now be deployed as container images using Docker instead of zip files. This research webpage discusses how lambda functions can be prototyped as container and its pros and cons.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="elastic-container-registry-ecr">Elastic Container Registry (ECR)<a href="#elastic-container-registry-ecr" class="hash-link" aria-label="Direct link to Elastic Container Registry (ECR)" title="Direct link to Elastic Container Registry (ECR)">​</a></h2><p>AWS Elastic Container Registry(ECR) is used to store container images for lambdas and is fully managed by AWS. It hosts the images in a highly available and scalable architecture, allowing developers to reliably deploy containers for their applications. See this <a href="https://aws.amazon.com/ecr/" target="_blank" rel="noopener noreferrer">link</a> for additional information on ECR. Currently, you have to use ECR to store container images for lambdas as it does not support other storage options such as Github, Dockerhub, etc.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pros-and-cons-of-using-container-for-lambdas">Pros and Cons of using container for lambdas<a href="#pros-and-cons-of-using-container-for-lambdas" class="hash-link" aria-label="Direct link to Pros and Cons of using container for lambdas" title="Direct link to Pros and Cons of using container for lambdas">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="pros">Pros<a href="#pros" class="hash-link" aria-label="Direct link to Pros" title="Direct link to Pros">​</a></h3><ul><li>Defining runtime environment in a container image gives developers more control over their environment compared to what they get with predefined runtimes and zipping dependencies. </li><li>you can now package and deploy Lambda functions as container images of up to 10 GB in size compared to only 250MB in case of lambda deployment package size. </li><li>preferable for data-heavy or dependency-heavy applications.</li><li>The Lambda service provides a variety of base image options with pre-installed runtimes that will be patched and maintained by AWS.</li><li>Once deployed, containerized lambdas have no additional cost compared to zipped lambdas except the cost of using ECR repository.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cons">Cons<a href="#cons" class="hash-link" aria-label="Direct link to Cons" title="Direct link to Cons">​</a></h3><ul><li>Container support requires your Lambda function code point to an ECR Repo URI which means that repo also has to be maintained.</li><li>need additional work to create the Dockerfile, tag and push the image to ECR repo.</li><li>Need additional work for deleting older images under the ECR repository.</li></ul><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Currently NGAP only allows <code>private</code> ECR repository which could bring possible risk and challenges in using a public repository for storing container image for lambdas. More discussion is needed with NGAP on allowing a public repository.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="new-configuration-for-lambda-container">New configuration for lambda container<a href="#new-configuration-for-lambda-container" class="hash-link" aria-label="Direct link to New configuration for lambda container" title="Direct link to New configuration for lambda container">​</a></h2><p>There are a few configuration that needs to be added if the lambda is deployed from docker image.</p><ul><li>Architecture- This  determines the type of computer processor that Lambda uses to run the function. Lambda provides a choice of instruction set architectures which is either <code>arm64</code> or <code>x86_64</code>. The <code>arm64</code> architecture offer lower cost per Gb/s compared to the other one. Check this <a href="https://docs.aws.amazon.com/lambda/latest/dg/foundation-arch.html?icmpid=docs_lambda_help" target="_blank" rel="noopener noreferrer">link</a> for additional information.</li><li>Image configuration- These are values that can be used to override the container image settings for <code>ENTRYPOINT</code>, <code>CMD</code>, <code>WORKDIR</code> and <code>ENV</code>.</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ENTRYPOINT – Specifies the absolute path of the entry point to the application.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  CMD – Specifies parameters that you want to pass in with ENTRYPOINT.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WORKDIR – Specifies the absolute path of the working directory.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ENV – Specifies an environment variable for the Lambda function.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Image URI- The location of the container image to use for your function.</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-prototype">Creating a prototype<a href="#creating-a-prototype" class="hash-link" aria-label="Direct link to Creating a prototype" title="Direct link to Creating a prototype">​</a></h2><p>Creating or updating the function is done by building a Docker image, uploading the new version to ECR and deploying/updating the Lambda function to point to the newly uploaded image using terraform. Docker CLI has been used to build, tag and push the container image to ECR.</p><p>The steps for prototyping lambda container are as follows:</p><ul><li>Create or locate an AWS ECR repository for storing the Docker images. </li><li>Create the Dockerfile and then build, tag and push the image to the above ECR repository.</li><li>Update terraform configuration of the lambda function to deploy it as container.</li></ul><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Currently NGAP only allows developers to create a <code>private</code> ECR repository which was used here to create the prototype. Using a <code>public</code> ECR repository will need approval from NGAP first which could bring security concerns.</p></div></div><p>Details on creating the prototype are shown below:</p><ol><li>Create an <a href="https://us-west-2.console.aws.amazon.com/ecr/repositories" target="_blank" rel="noopener noreferrer">ECR</a> repository from AWS CLI if needed as shown. Check <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html#cli-create-repository" target="_blank" rel="noopener noreferrer">here</a> for additional details on this.</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">aws ecr create-repository </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    --repository-name </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">YOUR_REPOSITORY_NAME</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>Create a project directory. Under that directory, add  your script (<code>test.py</code> in this case) and <code>requirements.txt</code>to install any dependencies. Then create a <code>Dockerfile</code> that creates the image. </li></ol><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>  You should use the AWS lambda base image specific to the language you are using to write the lambda function.</p></div></div><p>An example of a Dockerfile used for prototying a lambda having <code>test.py</code> file is shown below.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM public.ecr.aws/lambda/python</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token number" style="color:rgb(247, 140, 108)">3.8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Copy function code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY test.py $</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">LAMBDA_TASK_ROOT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Install the function&#x27;s dependencies using file requirements.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># from your project folder.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY requirements.txt  .</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN  pip3 install </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r requirements.txt </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">target &quot;$</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">LAMBDA_TASK_ROOT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Set the CMD to your handler (could also be done as a parameter override outside of the Dockerfile)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CMD </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;test.lambda_handler&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="3"><li>The next steps are to build, tag and push the image to the ECR repo. You can build a new image named <code>prototype-lambda-image</code> in this case using:</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> build -t prototype-lambda-image </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once build is successful, tag the image</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> tag prototype-lambda-image:</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">IMAGE_TAG</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">YOUR_ECR_REPO_URI</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">:</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">IMAGE_TAG</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Next, login to the ECR repo using:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">aws ecr get-login-password --region </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">YOUR_REGION</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> login --username AWS --password-stdin </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">YOUR_AWS_ACCOUNT_ID</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">.dkr.ecr.</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">YOUR_REGION</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">.amazonaws.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Check this <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html" target="_blank" rel="noopener noreferrer">link</a> for additional information on pushing image to ECR using Docker CLI.</p><p>Finally, push the image to ECR using:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">docker</span><span class="token plain"> push </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">YOUR_ECR_REPO_URI</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">:</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">IMAGE_TAG</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li>The next step is to deploy the lambda using terraform. Use the following example code to deploy the lambda container:</li></ol><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_lambda_function&quot; &quot;prototype_lambda&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  image_uri     = &quot;&lt;YOUR_ECR_REPO_URI&gt;:&lt;IMAGE_TAG&gt;&quot;  # repo and tag</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  package_type  = &quot;Image&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  function_name = &quot;prototype-lambda&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  role          = &quot;&lt;YOUR_IAM_ROLE_ARN&gt;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  image_config {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    command = [&quot;test.lambda_handler&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using the steps above, a prototype has been created in NGAP AWS sandbox account which can be seen under the lambda function console. The lambda function is named as <code>prototype-lambda-container</code> and uses the <code>test:latest</code> private ECR repo image.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="future-directions">Future directions<a href="#future-directions" class="hash-link" aria-label="Direct link to Future directions" title="Direct link to Future directions">​</a></h2><p>Currently, the only option to store the Docker image for lambda containers is AWS ECR repository. Github package could be an option to store the image but in order to deploy the lambda, the image has to be stored into an ECR.</p><p>The above example Dockerfile does not follow best practices. See example in section on Fargate.</p><p>A few possible discussion items:</p><ul><li>Discuss with NGAP team if the docker images can be stored in a public ECR repo.</li><li>If github packages are supported to store and deploy the lambda, then we have to contact NASA github admins to enable this feature in our repository.</li></ul><p>Based on this research, it looks like using lambda as containers is possible when using a private ECR to store the image which is not ideal in our case. There are some concerns which include:</p><ul><li>Discussing with NGAP on allowing to store container images on a public ECR repository. If that is not possible, another option is to have an ECR setup for the end user via terraform and build images. This will require additional work.</li><li>If github package is used to store the image, deploying lambda as container will be an issue since the terraform only supports deploying the image from ECR. Moreover, this feature for the github repository has to be approved by NASA Github admins.</li></ul><p>If the above issues are solved, then implementing lambda as container is recommended. One way to use private ECR repo is to use a script or terraform code if possible that will create the ECR repo and then build, tag and push the container image to that repo. One that is done, update the terraform lambda modules and deploy the lambda. An additional <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-375" target="_blank" rel="noopener noreferrer">card</a> has been created to look into this way.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="modifying-get_current_archive_list-and-perform_orca_reconcile">Modifying get_current_archive_list and perform_orca_reconcile<a href="#modifying-get_current_archive_list-and-perform_orca_reconcile" class="hash-link" aria-label="Direct link to Modifying get_current_archive_list and perform_orca_reconcile" title="Direct link to Modifying get_current_archive_list and perform_orca_reconcile">​</a></h3><p>The Orca Internal Reconciliation workflow lambdas require an alternative approach.</p><ul><li><p>The maximum time limit for lambdas is 15 minutes. These lambdas may take a significant amount of time, and should not be subject to this limitation.</p></li><li><p>Code changes</p><ul><li>Merge <code>get_current_archive_list</code> and <code>perform_orca_reconcile</code> into one codebase.</li><li>Wrap functionality in a loop that will process the internal-report queue until no entries remain.</li><li>Since ECS does not support timeout, create an overarching timing mechanic that exits if an infinite loop occurs while processing a queue entry.<ul><li>Alternatively, a side-program could manually stop the task if it exceeds its&#x27; time limit.</li><li>Remember that in addition to processing time, Aurora Serverless can take up to 5 minutes to spin up.</li></ul></li><li>Raise the internal-report queue&#x27;s <code>visibility_timeout_seconds</code> to the expected timeout.</li><li>Environment variables can be passed in at task definition, or when the task is run. The former should be sufficient.</li></ul></li><li><p>Use an alternative Dockerfile. The example below packages two code files into a lightweight python container with a <code>CMD</code> to run the main file.</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Build Stage - Here we can bring dev libraries and compile the wheels for the python libs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># =============================================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM python</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">3.8</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">slim as builder</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ENV PYTHONDONTWRITEBYTECODE 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ENV PYTHONUNBUFFERED 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Install the function&#x27;s dependencies using file requirements.txt</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># from your project folder.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY requirements.txt  .</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN pip wheel </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">no</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cache</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dir </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">no</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">deps </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">wheel</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">dir /app/wheels </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r requirements.txt</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Run Stage - Contains everything needed to run code with entry point</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ===================================================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">FROM python</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">3.8</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">slim</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># CREATE Non-Privileged User</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN mkdir </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">p /app \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token important">&amp;&amp;</span><span class="token plain"> groupadd </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r appuser \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token important">&amp;&amp;</span><span class="token plain"> useradd </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">r </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">s /bin/false </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">g appuser appuser \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token important">&amp;&amp;</span><span class="token plain"> chown </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">R appuser</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">appuser /app</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Copy compiled wheels and install the requirements</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">from=builder /app/wheels /wheels</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RUN pip install </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">no</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">cache /wheels/*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Set the work directory for our application</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WORKDIR /app</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Copy function code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY main.py main.py</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COPY sqs_library.py sqs_library.py</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Set the User that the app will run as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">USER appuser</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Set the entry point for the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ENTRYPOINT </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;python&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;main.py&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Follow prior instructions up to the Terraform deployment. Use the following Terraform instead of the previous example.</p></li></ul><div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-terraform codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;sqs_task_policy_document&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    actions   = [&quot;sts:AssumeRole&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    resources = [&quot;*&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    actions = [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;sqs:ReceiveMessage&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;sqs:SendMessage&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;sqs:DeleteMessage&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;sqs:GetQueueAttributes&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    resources = [&quot;*&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data &quot;aws_iam_policy_document&quot; &quot;assume_ecs_tasks_role_policy_document&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  statement {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    principals {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      type        = &quot;Service&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      identifiers = [&quot;ecs-tasks.amazonaws.com&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    actions = [&quot;sts:AssumeRole&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># IAM role that tasks can use to make API requests to authorized AWS services.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;orca_ecs_tasks_role&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name                 = &quot;${var.prefix}_orca_ecs_tasks_role&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  assume_role_policy   = data.aws_iam_policy_document.assume_ecs_tasks_role_policy_document.json</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  permissions_boundary = var.permissions_boundary_arn</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  tags                 = var.tags</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_iam_role_policy&quot; &quot;sqs_task_role_policy&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name   = &quot;${var.prefix}_orca_sqs_task_role_policy&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  role   = aws_iam_role.orca_ecs_tasks_role.id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy = data.aws_iam_policy_document.sqs_task_policy_document.json</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># This role is required by tasks to pull container images and publish container logs to Amazon CloudWatch on your behalf.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_iam_role&quot; &quot;orca_ecs_task_execution_role&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name                 = &quot;${var.prefix}_orca_ecs_task_execution_role&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  assume_role_policy   = data.aws_iam_policy_document.assume_ecs_tasks_role_policy_document.json</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  permissions_boundary = var.permissions_boundary_arn</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  tags                 = var.tags</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_iam_role_policy_attachment&quot; &quot;ecs_role_policy&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  role       = aws_iam_role.orca_ecs_task_execution_role.name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  policy_arn = &quot;arn:aws:iam::aws:policy/AdministratorAccess&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_ecs_cluster&quot; &quot;test-cluster&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name = &quot;${var.prefix}_orca_ecs_cluster&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  capacity_providers = [&quot;FARGATE&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  default_capacity_provider_strategy {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    capacity_provider = &quot;FARGATE&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    weight            = 100</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"># Defines how the image will be run. container_definitions can be replaced by data element.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">resource &quot;aws_ecs_task_definition&quot; &quot;task&quot; {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  family                   = &quot;${var.prefix}_orca_sqs_task&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  network_mode             = &quot;awsvpc&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  requires_compatibilities = [&quot;FARGATE&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  cpu                      = &quot;4096&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  memory                   = &quot;8192&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  task_role_arn            = aws_iam_role.orca_ecs_tasks_role.arn</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  execution_role_arn       = aws_iam_role.orca_ecs_task_execution_role.arn</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  container_definitions    = &lt;&lt;DEFINITION</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">[</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;name&quot;: &quot;sqs_task_container&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;image&quot;: &quot;999999999999.dkr.ecr.us-west-2.amazonaws.com/adorn-test-repo:latest&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;cpu&quot;: 4096,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;memory&quot;: 256,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;networkMode&quot;: &quot;awsvpc&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;environment&quot;: [</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;name&quot;: &quot;TARGET_QUEUE_URL&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;value&quot;: &quot;https://sqs.us-west-2.amazonaws.com/999999999999/doctest-orca-internal-report-queue.fifo&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    &quot;logConfiguration&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;logDriver&quot;: &quot;awslogs&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &quot;options&quot;: {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;awslogs-create-group&quot;: &quot;true&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;awslogs-region&quot;: &quot;us-west-2&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;awslogs-group&quot;: &quot;${var.prefix}_orca_sqs_task&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &quot;awslogs-stream-prefix&quot;: &quot;ecs&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">DEFINITION</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_S0QG"><p>The above example was developed for deploying a simple task that posts to an sqs queue. Names and values should be changed to match new use cases.
Values such as <code>cpu</code> and <code>memory</code> should similarly be reevaluated.</p></div></div><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_S0QG"><p>Applying admin permissions to orca_ecs_task_execution_role is likely overly permissive.</p></div></div><ul><li>The Fargate task can now be run in the ECS cluster.
This can be done through <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ecs.html#ECS.Client.run_task" target="_blank" rel="noopener noreferrer">boto3</a> or the GUI,
though the former is presently untested.</li><li><a href="https://aws.amazon.com/ecs/pricing/?trk=2f064982-4fad-4e1f-ab75-e1df26258a60&amp;sc_channel=ps&amp;sc_campaign=acquisition&amp;sc_medium=GC-PMM%7CPS-GO%7CBrand%7CAll%7CPA%7CDatabase%7CECS%7CProduct%7CUS%7CEN%7CText%7Cxx%7CSEM%7CPMO22-13405&amp;s_kwcid=AL!4422!3!547620651289!e!!g!!amazon%20ecs%20pricing&amp;ef_id=EAIaIQobChMIsO-ehu2l9wIVCfrICh0gOQ5OEAAYASABEgIZmfD_BwE:G:s&amp;s_kwcid=AL!4422!3!547620651289!e!!g!!amazon%20ecs%20pricing" target="_blank" rel="noopener noreferrer">Pricing</a> only applies to what is used in the moment, and can auto-scale down.<ul><li>Minimum compute time is one minute, so this architecture should not be used for small, frequent tasks.</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="recommendation">Recommendation<a href="#recommendation" class="hash-link" aria-label="Direct link to Recommendation" title="Direct link to Recommendation">​</a></h4><p>Recommend use of the above architecture to resolve concerns with timeouts when handling large inventories.
get_current_archive_list and perform_orca_reconcile can be merged into one codebase, with an overarching loop. <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-428" target="_blank" rel="noopener noreferrer">https://bugs.earthdata.nasa.gov/browse/ORCA-428</a>
This script can be built into a Docker container and deployed to the result of <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-375" target="_blank" rel="noopener noreferrer">ECR reserach</a>. <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-429" target="_blank" rel="noopener noreferrer">https://bugs.earthdata.nasa.gov/browse/ORCA-429</a>
This new script can then be deployed as a task definition in AWS. <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-432" target="_blank" rel="noopener noreferrer">https://bugs.earthdata.nasa.gov/browse/ORCA-432</a>
We should also create our own ECS cluster to decouple from Cumulus. <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-433" target="_blank" rel="noopener noreferrer">https://bugs.earthdata.nasa.gov/browse/ORCA-433</a>
The task definition can be run periodically in the ECS cluster to empty the queue of any internal reconciliation jobs. <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-430" target="_blank" rel="noopener noreferrer">https://bugs.earthdata.nasa.gov/browse/ORCA-430</a>
We can either remove triggering from post_to_queue_and_trigger_step_function or update it to trigger the Fargate task when called.
In either case, the old workflow can be removed. <a href="https://bugs.earthdata.nasa.gov/browse/ORCA-431" target="_blank" rel="noopener noreferrer">https://bugs.earthdata.nasa.gov/browse/ORCA-431</a></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h5><ul><li><a href="https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/aws/new-for-aws-lambda-container-image-support/</a></li><li><a href="https://aws.amazon.com/blogs/compute/optimizing-lambda-functions-packaged-as-container-images/" target="_blank" rel="noopener noreferrer">https://aws.amazon.com/blogs/compute/optimizing-lambda-functions-packaged-as-container-images/</a></li><li><a href="https://dashbird.io/blog/deploying-aws-lambda-with-docker/" target="_blank" rel="noopener noreferrer">https://dashbird.io/blog/deploying-aws-lambda-with-docker/</a></li><li><a href="https://docs.aws.amazon.com/lambda/latest/dg/images-create.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/lambda/latest/dg/images-create.html</a></li><li><a href="https://docs.aws.amazon.com/lambda/latest/dg/python-image.html" target="_blank" rel="noopener noreferrer">https://docs.aws.amazon.com/lambda/latest/dg/python-image.html</a></li><li><a href="https://acloudguru.com/blog/engineering/packaging-aws-lambda-functions-as-container-images" target="_blank" rel="noopener noreferrer">https://acloudguru.com/blog/engineering/packaging-aws-lambda-functions-as-container-images</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/research/research-lambda-container.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cumulus-orca/docs/developer/research/research-bamboo-integration-tests"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Research Notes on running integration tests in bamboo CI/CD</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cumulus-orca/docs/developer/research/research-pushing-docker-image"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Notes on pushing and deploying docker images.</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#elastic-container-registry-ecr" class="table-of-contents__link toc-highlight">Elastic Container Registry (ECR)</a></li><li><a href="#pros-and-cons-of-using-container-for-lambdas" class="table-of-contents__link toc-highlight">Pros and Cons of using container for lambdas</a><ul><li><a href="#pros" class="table-of-contents__link toc-highlight">Pros</a></li><li><a href="#cons" class="table-of-contents__link toc-highlight">Cons</a></li></ul></li><li><a href="#new-configuration-for-lambda-container" class="table-of-contents__link toc-highlight">New configuration for lambda container</a></li><li><a href="#creating-a-prototype" class="table-of-contents__link toc-highlight">Creating a prototype</a></li><li><a href="#future-directions" class="table-of-contents__link toc-highlight">Future directions</a><ul><li><a href="#modifying-get_current_archive_list-and-perform_orca_reconcile" class="table-of-contents__link toc-highlight">Modifying get_current_archive_list and perform_orca_reconcile</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/about/introduction/orca-intro">About ORCA</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/developer/quickstart/developer-intro">ORCA Developer Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/cumulus-orca/docs/operator/operator-intro">ORCA Operator Guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/ORCA+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">ORCA Working Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/nasa/cumulus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Project<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cumulus+Integrators+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Integrator Working Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://wiki.earthdata.nasa.gov/display/CUMULUS/Cumulus+Operator+Working+Group" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Operator Working Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://nasa.github.io/cumulus/docs/cumulus-docs-readme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cumulus Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/nasa/cumulus-orca" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/cumulus-orca/assets/js/runtime~main.db236747.js"></script>
<script src="/cumulus-orca/assets/js/main.12f41519.js"></script>
</body>
</html>
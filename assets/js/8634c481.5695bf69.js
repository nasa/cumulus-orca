"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[7944],{4158:(e,r,a)=>{a.r(r),a.d(r,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>d});var o=a(4848),n=a(8453);const s={id:"research-pushing-docker-image",title:"Notes on pushing and deploying docker images.",description:"Research notes on pushing Docker images for end users"},i=void 0,t={id:"developer/research/research-pushing-docker-image",title:"Notes on pushing and deploying docker images.",description:"Research notes on pushing Docker images for end users",source:"@site/docs/developer/research/research-pushing-docker-image.md",sourceDirName:"developer/research",slug:"/developer/research/research-pushing-docker-image",permalink:"/cumulus-orca/docs/developer/research/research-pushing-docker-image",draft:!1,unlisted:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/research/research-pushing-docker-image.md",tags:[],version:"current",frontMatter:{id:"research-pushing-docker-image",title:"Notes on pushing and deploying docker images.",description:"Research notes on pushing Docker images for end users"},sidebar:"dev_guide",previous:{title:"Using Lambda functions as container research Notes",permalink:"/cumulus-orca/docs/developer/research/research-lambda-container"},next:{title:"S3 Future Direction/Best Practices",permalink:"/cumulus-orca/docs/developer/research/research-s3-bucket-best-practices"}},c={},d=[{value:"Deploying ECR",id:"deploying-ecr",level:2},{value:"Github Packages",id:"github-packages",level:2},{value:"Pulling from Github repo and pushing to ECR",id:"pulling-from-github-repo-and-pushing-to-ecr",level:2},{value:"Alternative approach to pull and push images to ECR using Packer",id:"alternative-approach-to-pull-and-push-images-to-ecr-using-packer",level:2},{value:"Prototyping using github package",id:"prototyping-using-github-package",level:2},{value:"Future directions and recommendations",id:"future-directions-and-recommendations",level:2},{value:"References",id:"references",level:5}];function p(e){const r={a:"a",admonition:"admonition",code:"code",h2:"h2",h5:"h5",li:"li",p:"p",pre:"pre",ul:"ul",...(0,n.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.h2,{id:"deploying-ecr",children:"Deploying ECR"}),"\n",(0,o.jsx)(r.p,{children:"ECR repo can be deploying using terraform as shown below."}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-terraform",children:'resource "aws_ecr_repository" "prototype_repo" {\n  name                 = "prototype_repo"\n\n  image_scanning_configuration {\n    scan_on_push = false\n  }\n}\noutput "ecr_repo_url" {\n    value = aws_ecr_repository.prototype_repo.repository_url\n}\n'})}),"\n",(0,o.jsx)(r.h2,{id:"github-packages",children:"Github Packages"}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.a,{href:"https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages",children:"Github packages"})," looks like a good platform to store public or private docker images. GitHub Packages usage is free for public packages. For private packages, each account on GitHub receives a certain amount of free storage and data transfer, depending on the product used with the account. Any usage beyond the included amounts is controlled by spending limits. Currently, this github package feature is already being used by our NASA ",(0,o.jsx)(r.a,{href:"https://github.com/orgs/nasa/packages",children:"repository"}),"."]}),"\n",(0,o.jsx)(r.p,{children:"The steps to push a docker image to github repository are shown below. Make sure Docker CLI is installed on your machine."}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"Create a DockerFile that will create the image."}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-yaml",children:"#This is a sample image\nFROM alpine:3.4\nRUN apk update\nRUN apk add vim \nCMD [\u201cecho\u201d,\u201dSample image created\u201d]\n"})}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["Build the image using ",(0,o.jsx)(r.code,{children:"docker build -t sample-image ."}),"."]}),"\n",(0,o.jsxs)(r.li,{children:["Once the image is there, the next step is to push to github. However, the user will first need to authenticate with github using a ",(0,o.jsx)(r.code,{children:"personal access token"}),". See details ",(0,o.jsx)(r.a,{href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token",children:"here"})," on how to create the token."]}),"\n"]}),"\n",(0,o.jsx)(r.admonition,{type:"important",children:(0,o.jsxs)(r.p,{children:["Github packages might need to be approved by NASA admins for use. In addition, proper permissions need to be granted to the token such as ",(0,o.jsx)(r.code,{children:"write_package"})," in order to push to github."]})}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"Once the token is created, sign in to the github container registry using:"}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"export CR_PAT=YOUR_PERSONAL_TOKEN\necho $CR_PAT | docker login ghcr.io -u <GITHUB_USERNAME> --password-stdin\n"})}),"\n",(0,o.jsxs)(r.p,{children:["Replace ",(0,o.jsx)(r.code,{children:"<USERNAME>"})," with your github username. It will show ",(0,o.jsx)(r.code,{children:"Login Succeeded"})," upon success."]}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["Tag the docker image using the following format. Note that the format must be ",(0,o.jsx)(r.code,{children:"ghcr.io/<GITHUB_USERNAME>/<image_name>:<image_tag>"}),". The image name must have the prefix ",(0,o.jsx)(r.code,{children:"cumulus-orca/"}),". e.g. ",(0,o.jsx)(r.code,{children:"cumulus-orca/<image_name>:<image_tag>"}),". Note that ",(0,o.jsx)(r.code,{children:"<image_tag>"})," is the image version."]}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:'docker tag <image_name> ghcr.io/<GITHUB_USERNAME>/<image_name>:<image_tag>\n# example using image name "cumulus-orca/sample-image:latest" and github username "nasa"\ndocker tag sample-image ghcr.io/nasa/cumulus-orca/sample-image:latest\n'})}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"Finally push the image"}),"\n"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"docker push ghcr.io/username/sample-image\n"})}),"\n",(0,o.jsx)(r.admonition,{type:"note",children:(0,o.jsx)(r.p,{children:"Make sure your username matches with your github username or else it will show error while pushing the image."})}),"\n",(0,o.jsxs)(r.p,{children:["Once the image is pushed, it  can be view under ",(0,o.jsx)(r.code,{children:"Packages"})," section in github. However, the image will be private by default. Click on the ",(0,o.jsx)(r.code,{children:"package settings"})," page to change from private to public if needed."]}),"\n",(0,o.jsx)(r.h2,{id:"pulling-from-github-repo-and-pushing-to-ecr",children:"Pulling from Github repo and pushing to ECR"}),"\n",(0,o.jsx)(r.p,{children:"Docker image in github repository can then be pulled by other users using"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"docker pull ghcr.io/<GITHUB_USERNAME>/<image_name>:<TAG>\n#example\ndocker pull ghcr.io/username/sample-image:latest\n\n"})}),"\n",(0,o.jsx)(r.p,{children:"Once image is pulled and ECR is deployed, login to ECR and then tag and push the image."}),"\n",(0,o.jsx)(r.admonition,{type:"note",children:(0,o.jsx)(r.p,{children:"Make sure to properly tag the image or else it will give an error."})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"#login to ECR\naws ecr get-login-password --region <YOUR_REGION> | docker login --username AWS --password-stdin <YOUR_AWS_ACCOUNT_ID>.dkr.ecr.<YOUR_REGION>.amazonaws.com\n#example\naws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 123456789.dkr.ecr.us-west-2.amazonaws.com\n"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"#tag your local image with your ECR repo name\ndocker tag <IMAGE_NAME>:<IMAGE_TAG> <YOUR_AWS_ECR_REPO_URI>:<IMAGE_TAG>\n#example\ndocker tag ghcr.io/username/sample-image:latest 123456789.dkr.ecr.us-west-2.amazonaws.com/prototype_repo:prototype\n"})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"#push image to your ECR\ndocker push <YOUR_ECR_REPO_URI>:<IMAGE_TAG>\n#example\ndocker push 123456789.dkr.ecr.us-west-2.amazonaws.com/prototype_repo:prototype\n"})}),"\n",(0,o.jsx)(r.h2,{id:"alternative-approach-to-pull-and-push-images-to-ecr-using-packer",children:"Alternative approach to pull and push images to ECR using Packer"}),"\n",(0,o.jsxs)(r.p,{children:["Another approach to pull, tag and push images from github repository to AWS ECR is to use Hashicorp ",(0,o.jsx)(r.a,{href:"https://www.packer.io/",children:"Packer"})," that can automatically build and push docker images to AWS. It uses the HashiCorp Configuration Language (HCL). A sample working script named ",(0,o.jsx)(r.code,{children:"test.pkr.hcl"})," deployed to AWS sandbox is shown below:"]}),"\n",(0,o.jsx)(r.admonition,{type:"note",children:(0,o.jsx)(r.p,{children:'Make sure the file name ends with ".pkr.hcl"'})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:'packer {\n  # install required plugins\n  required_plugins {\n    docker = {\n      version = ">= 1.0.1"\n      source  = "github.com/hashicorp/docker"\n    }\n  }\n}\n\nvariable  "ecr_repository_url" {\n  type = string\n  sensitive = true\n}\n\nvariable  "image_version" {\n  type = string\n}\n\n# pull the image from github repo\nsource "docker" "prototype_image" {\n  image = "ghcr.io/rizbihassan/cumulus-orca/sample-image:latest"\n  commit = true\n}\n# build the image\nbuild {\n  sources = ["source.docker.prototype_image"]\n# tag the image\n  post-processors {\n    post-processor "docker-tag" {\n        repository = var.ecr_repository_url\n        tags = [var.image_version]\n    }\n    # push the image to ECR repo that was deployed using terraform previously\n    post-processor "docker-push" {\n        ecr_login = true\n        login_server = var.ecr_repository_url\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(r.p,{children:["Run the packer file using the command below. Replace ",(0,o.jsx)(r.code,{children:"<ECR_REPOSITORY_URL>"})," and ",(0,o.jsx)(r.code,{children:"<IMAGE_VERSION>"})," with yours."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"packer build -var 'ecr_repository_url=<ECR_REPOSITORY_URL>' -var 'image_version=<IMAGE_VERSION>' test.pkr.hcl\n"})}),"\n",(0,o.jsx)(r.p,{children:"The output will show something like this if successful:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-bash",children:"user$ packer build -var 'ecr_repository_url=123456789.dkr.ecr.us-west-2.amazonaws.com/prototype_repo' -var 'image_version=v1' test.pkr.hcl\ndocker.prototype_image: output will be in this color.\n\n==> docker.prototype_image: Creating a temporary directory for sharing data...\n==> docker.prototype_image: Pulling Docker image: ghcr.io/rizbihassan/cumulus-orca/sample-image:latest\n    docker.prototype_image: latest: Pulling from rizbihassan/cumulus-orca/sample-image\n    docker.prototype_image: Status: Image is up to date for ghcr.io/rizbihassan/cumulus-orca/sample-image:latest\n    docker.prototype_image: ghcr.io/rizbihassan/cumulus-orca/sample-image:latest\n==> docker.prototype_image: Starting docker container...\n    docker.prototype_image: Run command: docker run -v /Users/rhassan/.config/packer/tmp867764898:/packer-files -d -i -t --entrypoint=/bin/sh -- ghcr.io/rizbihassan/cumulus-orca/sample-image:latest\n    docker.prototype_image: Container ID: edbdd851c37304379f241adbec0ca4aecc601c92f7f0ea60d928b3be7ed13224\n==> docker.prototype_image: Using docker communicator to connect: 172.17.0.3\n==> docker.prototype_image: Committing the container\n    docker.prototype_image: Image ID: sha256:a68fd0613f72473f1f11bf81a87eedd308e8e0c7cc9d6568467ddd4e4df5c2aa\n==> docker.prototype_image: Killing the container: edbdd851c37304379f241adbec0ca4aecc601c92f7f0ea60d928b3be7ed13224\n==> docker.prototype_image: Running post-processor:  (type docker-tag)\n    docker.prototype_image (docker-tag): Tagging image: sha256:a68fd0613f72473f1f11bf81a87eedd308e8e0c7cc9d6568467ddd4e4df5c2aa\n    docker.prototype_image (docker-tag): Repository: <sensitive>:v1\n==> docker.prototype_image: Running post-processor:  (type docker-push)\n    docker.prototype_image (docker-push): Fetching ECR credentials...\n    docker.prototype_image (docker-push): Logging in...\n    docker.prototype_image (docker-push): Login Succeeded\n    docker.prototype_image (docker-push): Pushing: <sensitive>:v1\n    docker.prototype_image (docker-push): The push refers to repository [<sensitive>]\n    docker.prototype_image (docker-push): f2f1289d6a81: Preparing\n    docker.prototype_image (docker-push): 4dda5747d6f4: Preparing\n    docker.prototype_image (docker-push): dbb5c5e8d571: Preparing\n    docker.prototype_image (docker-push): 23f7bd114e4a: Preparing\n    docker.prototype_image (docker-push): f2f1289d6a81: Pushed\n    docker.prototype_image (docker-push): v1: digest: sha256:29c151d20a3d1e8e525e9af4e7292f0e99d8f8cd64d7bcba289ceafc77a2ea98 size: 1156\n    docker.prototype_image (docker-push): Pushing: <sensitive>:v1\n    docker.prototype_image (docker-push): The push refers to repository [<sensitive>]\n    docker.prototype_image (docker-push): f2f1289d6a81: Preparing\n    docker.prototype_image (docker-push): 4dda5747d6f4: Preparing\n    docker.prototype_image (docker-push): dbb5c5e8d571: Preparing\n    docker.prototype_image (docker-push): 23f7bd114e4a: Preparing\n    docker.prototype_image (docker-push): v1: digest: sha256:29c151d20a3d1e8e525e9af4e7292f0e99d8f8cd64d7bcba289ceafc77a2ea98 size: 1156\n    docker.prototype_image (docker-push): Logging out...\n    docker.prototype_image (docker-push): Removing login credentials for 000000000000.dkr.ecr.us-west-2.amazonaws.com\nBuild 'docker.prototype_image' finished after 13 seconds 305 milliseconds.\n\n==> Wait completed after 13 seconds 305 milliseconds\n\n==> Builds finished. The artifacts of successful builds are:\n--\x3e docker.prototype_image: Imported Docker image: sha256:a68fd0613f72473f1f11bf81a87eedd308e8e0c7cc9d6568467ddd4e4df5c2aa\n--\x3e docker.prototype_image: Imported Docker image: <sensitive>:v1 with tags <sensitive>:v1\n\n"})}),"\n",(0,o.jsx)(r.h2,{id:"prototyping-using-github-package",children:"Prototyping using github package"}),"\n",(0,o.jsxs)(r.p,{children:["A prototype of a github package has been created by following the steps above and can be seen ",(0,o.jsx)(r.a,{href:"https://github.com/users/rizbihassan/packages/container/package/cumulus-orca/sample-image",children:"here"}),". Note that a personal github account has been used for prototyping since it requires creating a personal access token first. The github repository containing image that was pulled from github repo above and pushed to ECR using packer can be found in the ECR console and is named ",(0,o.jsx)(r.code,{children:"prototype_repo"}),"."]}),"\n",(0,o.jsx)(r.h2,{id:"future-directions-and-recommendations",children:"Future directions and recommendations"}),"\n",(0,o.jsx)(r.p,{children:"Using github packages for storing docker container looks promising, easy to use and free of cost. However, the user will need to create a personal access token having proper permissions first to login to github package and push images which could cause some delay. No token is necessary to pull public images from github repository. While Docker CLI can be used to build and tag the image, it is not the ideal way to push to ECR. The better and automated approach would be using Packer as shown above. Once ECR is deployed with terraform, Packer can then be used to pull and push the image to ECR.\nSome cards that  could be written are as follows:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:"Create a personal access token(PAT) for github container registry with proper permissions. Work with NASA admins."}),"\n",(0,o.jsx)(r.li,{children:"Push Docker images to github repository as needed."}),"\n"]}),"\n",(0,o.jsx)(r.h5,{id:"references",children:"References"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages",children:"https://docs.github.com/en/packages/learn-github-packages/introduction-to-github-packages"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token",children:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#visibility-and-access-permissions-for-container-images",children:"https://docs.github.com/en/packages/learn-github-packages/configuring-a-packages-access-control-and-visibility#visibility-and-access-permissions-for-container-images"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://github.com/nasa/cumulus-orca/blob/develop/website/docs/developer/research/research-lambda-container.md",children:"https://github.com/nasa/cumulus-orca/blob/develop/website/docs/developer/research/research-lambda-container.md"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://www.packer.io/guides/hcl/variables",children:"https://www.packer.io/guides/hcl/variables"})}),"\n",(0,o.jsx)(r.li,{children:(0,o.jsx)(r.a,{href:"https://thoughtmechanix.com/posts/8.01.2021_packer/",children:"https://thoughtmechanix.com/posts/8.01.2021_packer/"})}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,n.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(p,{...e})}):p(e)}},8453:(e,r,a)=>{a.d(r,{R:()=>i,x:()=>t});var o=a(6540);const n={},s=o.createContext(n);function i(e){const r=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),o.createElement(s.Provider,{value:r},e.children)}}}]);
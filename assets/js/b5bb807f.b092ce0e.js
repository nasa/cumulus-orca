"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[8999],{8551:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>l});var s=r(4848),o=r(8453);const t={id:"research-AuroraServerless",title:"Aurora Serverless Research Notes",description:"Research Notes on Aurora Serverless."},i=void 0,a={id:"developer/research/research-AuroraServerless",title:"Aurora Serverless Research Notes",description:"Research Notes on Aurora Serverless.",source:"@site/docs/developer/research/research-AuroraServerless.md",sourceDirName:"developer/research",slug:"/developer/research/research-AuroraServerless",permalink:"/cumulus-orca/docs/developer/research/research-AuroraServerless",draft:!1,unlisted:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/research/research-AuroraServerless.md",tags:[],version:"current",frontMatter:{id:"research-AuroraServerless",title:"Aurora Serverless Research Notes",description:"Research Notes on Aurora Serverless."},sidebar:"dev_guide",previous:{title:"ORCA Reconciliation",permalink:"/cumulus-orca/docs/developer/research/research-reconciliation"},next:{title:"GraphQL Research Notes",permalink:"/cumulus-orca/docs/developer/research/research-graphql"}},c={},l=[{value:"Overview",id:"overview",level:2},{value:"Implementation Details",id:"implementation-details",level:3},{value:"Future Direction",id:"future-direction",level:3},{value:"Sources",id:"sources",level:4}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://aws.amazon.com/rds/aurora/serverless/",children:"AWS Aurora Serverless"})," is a resource used by other teams for storage with scaling architecture.\nAs part of our plans to utilize Cumulus' database for Orca storage, research was conducted to preemptively identify pitfalls and needed changes."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"This page will not focus on moving to the database.\nInstead, emphasis will be placed on connecting to and querying an already-unified Serverless database."})}),"\n",(0,s.jsx)(n.h3,{id:"implementation-details",children:"Implementation Details"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"By default, Aurora scaling will only happen when no connections to the DB exist, but this can be overridden."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"This means that if we do not handle connections responsibly or optimize our queries, we could hold up scaling operations for other teams."})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"When scaling occurs, connections are cancelled, transactions are rolled back, locks are dropped, and temporary tables are dropped."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["In our current technology, PostgreSQL, ",(0,s.jsx)(n.a,{href:"https://www.postgresql.org/docs/8.3/tutorial-transactions.html",children:"each query is a transaction"}),"."]})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"When the Aurora DB is scaled down to zero, it takes some time to scale up."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["With SQLAlchemy this translated to a 30-40 second hang on ",(0,s.jsx)(n.code,{children:"engine.begin()"})]}),"\n",(0,s.jsxs)(n.li,{children:["The default timeout for SQLAlchemy appears to be ",(0,s.jsx)(n.a,{href:"https://docs.sqlalchemy.org/en/14/core/engines.html",children:"30 seconds"}),", though as mentioned previously connecting took 40 seconds with no issues.\nMay be multiple timeouts in play."]}),"\n",(0,s.jsx)(n.li,{children:"Scaling up after this point did not cause query performance degradation, despite what was documented. However, the UI is poorly made, and may be reporting incorrectly."}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Connections canceled due to scaling raise an error in SQLAlchemy.\nIf the query is ongoing:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'[SQL: \nSELECT pg_sleep(600);\n]\n(Background on this error at: http://sqlalche.me/e/14/e3q8)\nTraceback (most recent call last):\n  File "...\\venv\\lib\\site-packages\\sqlalchemy\\engine\\base.py", line 1770, in _execute_context\n    self.dialect.do_execute(\n  File "...\\venv\\lib\\site-packages\\sqlalchemy\\engine\\default.py", line 717, in do_execute\n    cursor.execute(statement, parameters)\npsycopg2.errors.AdminShutdown: terminating connection due to serverless scale event timeout\nSSL connection has been closed unexpectedly\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File ".../main.py", line 85, in <module>\n    connection.execute(wait_command)\n    ...\nsqlalchemy.exc.OperationalError: (psycopg2.errors.AdminShutdown) terminating connection due to serverless scale event timeout\nSSL connection has been closed unexpectedly\n'})}),"\n",(0,s.jsx)(n.p,{children:"If the query is starting up:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'Database connection failed due to (psycopg2.OperationalError) FATAL:  terminating connection because backend initialization completed past serverless scale point\n\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\nTraceback (most recent call last):\n  ...\n  File "...\\venv\\lib\\site-packages\\psycopg2\\__init__.py", line 122, in connect\n    conn = _connect(dsn, connection_factory=connection_factory, **kwasync)\npsycopg2.OperationalError: FATAL:  terminating connection because backend initialization completed past serverless scale point\n\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File ".../main.py", line 84, in <module>\n    with engine.begin() as connection:\n  File "...\\engine.py", line 393, in begin\n    conn = self.connect()\n  ...\nsqlalchemy.exc.OperationalError: (psycopg2.OperationalError) FATAL:  terminating connection because backend initialization completed past serverless scale point\n\n(Background on this error at: https://sqlalche.me/e/14/e3q8)\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Retrying when these errors occur should be sufficient to sidestep scaling errors, as scaling does not take long."}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsx)(n.p,{children:"Disconnections caused by these errors are NOT reported to Cloudwatch. Connecting lambdas/modules should have reliable and robust error logging."})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"future-direction",children:"Future Direction"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Modifications should be made to database code to account for AdminShutdown, OperationalError, and connection timeout issues."}),"\n",(0,s.jsx)(n.li,{children:"Timeouts for Lambdas/code that use the database should account for the 30-40 second scale-up-time."}),"\n",(0,s.jsxs)(n.li,{children:["Note that this code has not been tested with Lambdas.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://pypi.org/project/sqlalchemy-serverless-aurora-plugin/",children:"A SQLAlchemy plugin"}),' suggests that Lambdas "freeze" causing connection errors.',"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"I question whether this actually matters more for Aurora Serverless compared to base Aurora."}),"\n",(0,s.jsx)(n.li,{children:"Freeze only occurs after execution. Would be worth reviewing code to ensure connections do not live beyond lambda execution."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"sources",children:"Sources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://aws.amazon.com/blogs/database/best-practices-for-working-with-amazon-aurora-serverless/",children:"Best Practices for Working With Amazon Aurora Serverless"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/aurora-serverless.how-it-works.html",children:"Aurora Serverless: How it Works"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>a});var s=r(6540);const o={},t=s.createContext(o);function i(e){const n=s.useContext(t);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);
"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[6093],{320:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var s=n(4848),r=n(8453);const o={id:"research-s3-bucket-best-practices",title:"S3 Future Direction/Best Practices",description:"Research notes on S3 best practices and some directions to take development."},a=void 0,i={id:"developer/research/research-s3-bucket-best-practices",title:"S3 Future Direction/Best Practices",description:"Research notes on S3 best practices and some directions to take development.",source:"@site/docs/developer/research/research-s3-bucket-policies.md",sourceDirName:"developer/research",slug:"/developer/research/research-s3-bucket-best-practices",permalink:"/cumulus-orca/docs/developer/research/research-s3-bucket-best-practices",draft:!1,unlisted:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/research/research-s3-bucket-policies.md",tags:[],version:"current",frontMatter:{id:"research-s3-bucket-best-practices",title:"S3 Future Direction/Best Practices",description:"Research notes on S3 best practices and some directions to take development."},sidebar:"dev_guide",previous:{title:"Notes on pushing and deploying docker images.",permalink:"/cumulus-orca/docs/developer/research/research-pushing-docker-image"},next:{title:"Deep Archive Storage Migration Research Notes",permalink:"/cumulus-orca/docs/developer/research/research-deep-archive-migration"}},c={},l=[{value:"Overview",id:"overview",level:2},{value:"Universal Suggestions",id:"universal-suggestions",level:2},{value:"Deny Public Access",id:"deny-public-access",level:3},{value:"Deny Non-SSL Requests",id:"deny-non-ssl-requests",level:3},{value:"Encryption",id:"encryption",level:3},{value:"Versioned Archive Bucket",id:"versioned-archive-bucket",level:2},{value:"WORM Archive Bucket",id:"worm-archive-bucket",level:2},{value:"Additional Considerations",id:"additional-considerations",level:3},{value:"Reports Bucket",id:"reports-bucket",level:2},{value:"Automation",id:"automation",level:2},{value:"ACL Rule Replacement",id:"acl-rule-replacement",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(t.p,{children:["Presently, our S3 buckets are only defined through ",(0,s.jsx)(t.a,{href:"/cumulus-orca/docs/developer/deployment-guide/deployment-s3-bucket",children:"documentation"})," and there are changes we wish to make to support future development.\nThis document aims to document the desired final state of our S3 buckets."]}),"\n",(0,s.jsx)(t.h2,{id:"universal-suggestions",children:"Universal Suggestions"}),"\n",(0,s.jsx)(t.h3,{id:"deny-public-access",children:"Deny Public Access"}),"\n",(0,s.jsxs)(t.p,{children:["For all buckets, make sure that ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/access-control-block-public-access.html",children:"public access is disabled"}),".\nThis is the default behavior for new buckets, but may not be enforced on pre-existing buckets.\nSimply put, permissions should be granted on a case-by-case basis when needed."]}),"\n",(0,s.jsx)(t.h3,{id:"deny-non-ssl-requests",children:"Deny Non-SSL Requests"}),"\n",(0,s.jsx)(t.p,{children:"There is a desire to disallow non-SSL requests. This can theoretically be done with the following untested statement:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "Sid": "AllowSSLRequestsOnly",\n  "Action": "s3:*",\n  "Effect": "Deny",\n  "Resource": [\n    "arn:aws:s3:::PREFIX-orca-bucket-name",\n    "arn:aws:s3:::PREFIX-orca-bucket-name/*"\n  ],\n  "Condition": {\n    "Bool": {\n      "aws:SecureTransport": "false"\n    }\n  },\n  "Principal": "*"\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Testing should be done to identify any changes needed to lock out Non-SSL requests.\nA ",(0,s.jsx)(t.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-452",children:"Jira task"})," has been created to implement this limit."]}),"\n",(0,s.jsx)(t.h3,{id:"encryption",children:"Encryption"}),"\n",(0,s.jsxs)(t.p,{children:["A ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucket-encryption.html",children:"default encryption"})," should be used to encrypt data-at-rest, protecting it from attackers targeting storage mediums.\nSince Orca S3 buckets presently reside in a different account from the producers/consumers, this presently requires a customer-managed key with ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/premiumsupport/knowledge-center/s3-bucket-access-default-encryption/",children:"proper cross-account access"}),".\nNote that objects already in an un-encrypted bucket will not be automatically encrypted if encryption is added.\nA ",(0,s.jsx)(t.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-453",children:"Jira task"})," has been created to implement this feature."]}),"\n",(0,s.jsx)(t.h2,{id:"versioned-archive-bucket",children:"Versioned Archive Bucket"}),"\n",(0,s.jsx)(t.p,{children:"Suggested name: PREFIX-orca-archive-versioned"}),"\n",(0,s.jsxs)(t.p,{children:["Our ",(0,s.jsx)(t.a,{href:"/cumulus-orca/docs/developer/deployment-guide/deployment-s3-bucket",children:"current Archive bucket instructions"})," are well suited to storage.\nThere are a few changes we should consider."]}),"\n",(0,s.jsxs)(t.p,{children:["Presently, ORCA does not handle versioned data, but it also does not preclude that capability in its buckets.\nSetting versioning on Archive allows for finer-grained data backup as users could recover from a specific version of a file being overwritten.\nTo enable development towards this goal, we should either replace the existing bucket with a versioned bucket and move existing data over, or instruct users on how to ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/AmazonS3/latest/userguide/manage-versioning-examples.html",children:"enable versioning on their buckets"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["We should also remove the ACL capabilities due to AWS potential deprecation.\nThis will be detailed in a ",(0,s.jsx)(t.a,{href:"#acl-rule-replacement",children:"future section"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"worm-archive-bucket",children:"WORM Archive Bucket"}),"\n",(0,s.jsxs)(t.p,{children:["Note that this work depends on completing (ORCA-351)[",(0,s.jsx)(t.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-351",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-351"}),"]"]}),"\n",(0,s.jsx)(t.p,{children:"Suggested name: PREFIX-orca-archive-worm"}),"\n",(0,s.jsx)(t.p,{children:"Some data will never have additional versions. This includes raw or near-raw satellite data. This data should be stored in a Read Once Write Many (WORM) model, and be protected from accidental deletion, as it is the foundation of all derived data."}),"\n",(0,s.jsxs)(t.p,{children:["Permissions for this bucket will likely be identical to the ",(0,s.jsx)(t.a,{href:"#versioned-archive-bucket",children:"Versioned Archive Bucket"})]}),"\n",(0,s.jsxs)(t.p,{children:["The naming dichotomy between this and the ",(0,s.jsx)(t.a,{href:"#versioned-archive-bucket",children:"Versioned Archive Bucket"})," is slightly deceptive, as this bucket will be versioned as well.\nHowever, this is only to enable ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/blogs/storage/protecting-data-with-amazon-s3-object-lock/",children:"Object Lock"})]}),"\n",(0,s.jsx)(t.p,{children:"There are two modes of Object Lock:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["Governance\nUsers cannot delete files under this lock unless they both have an ",(0,s.jsx)(t.code,{children:"s3:BypassGovernanceRetention"})," permission on the bucket, and they use an override when calling the delete endpoint.\nThese holds automatically expire, but the expiration date can be arbitrarily far away."]}),"\n",(0,s.jsx)(t.li,{children:"Compliance\nThe lock must be removed before data can be deleted, and users must have special permissions to remove the lock.\nLocks have no expiration."}),"\n"]}),"\n",(0,s.jsxs)(t.p,{children:["I recommend Governance mode so as to allow a global Object Lock policy; with Compliance, we would need to be able to remove the lock to delete files, so a global policy is not possible.\nWith a default policy of ",(0,s.jsx)(t.code,{children:"Governance"})," mode and an arbitrarily long ",(0,s.jsx)(t.code,{children:"Retention period"}),", data will be protected from accidental deletion by general users."]}),"\n",(0,s.jsx)(t.h3,{id:"additional-considerations",children:"Additional Considerations"}),"\n",(0,s.jsx)(t.p,{children:"Note that due to poor API returns, attempting to delete a file that cannot be deleted returns HTTP status code 204. When deletes are added to Orca, effort should be taken to return a proper error/success response to customers."}),"\n",(0,s.jsx)(t.p,{children:"Due to technically being versioned, care should be taken when uploading as well.\nFiles should be rejected if they are already present in a WORM bucket, likely through an object lookup on the bucket."}),"\n",(0,s.jsx)(t.p,{children:"There is still a race condition if two clients upload the same file simultaneously.\nChecks should be done after a file is uploaded to make sure it is still the only version present.\nIf not, the uploaded version should be deleted, and an error message sent back to the client.\nIn the event that this mechanic fails, Internal Reconciliation should report errors on multiple versions of the same file within a WORM bucket."}),"\n",(0,s.jsx)(t.h2,{id:"reports-bucket",children:"Reports Bucket"}),"\n",(0,s.jsx)(t.p,{children:"Suggested name: PREFIX-orca-reports"}),"\n",(0,s.jsxs)(t.p,{children:["This bucket is relatively simple, as much of the interaction is automated through AWS. This bucket stores S3 Inventory reports generated by AWS, to be pulled in by ",(0,s.jsx)(t.code,{children:"get_current_archive_list"}),".\nVersioning is not used, and in general no changes are required beyond updating the Permissions to the policy below:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Sid": "Cross Account Access",\n      "Effect": "Allow",\n      "Principal": {\n        "AWS": "arn:aws:iam::012345678912:root"\n      },\n      "Action": [\n        "s3:GetObject",\n        "s3:GetObjectVersion",\n        "s3:RestoreObject",\n        "s3:GetBucketVersioning",\n        "s3:GetBucketNotification",\n        "s3:ListBucket",\n        "s3:PutBucketNotification",\n        "s3:GetInventoryConfiguration",\n        "s3:PutInventoryConfiguration",\n        "s3:ListBucketVersions"\n      ],\n      "Resource": [\n        "arn:aws:s3:::PREFIX-orca-archive-versioned",\n        "arn:aws:s3:::PREFIX-orca-archive-versioned/*"\n      ]\n    },\n    {\n      "Sid": "Inventory-PREFIX-orca-archive-versioned",\n      "Effect": "Allow",\n      "Principal": {\n        "Service": "s3.amazonaws.com"\n      },\n      "Action": "s3:PutObject",\n      "Resource": "arn:aws:s3:::PREFIX-orca-archive-versioned/*",\n      "Condition": {\n        "StringEquals": {\n      \t  "aws:SourceAccount": "0000000000000"\n        },\n      \t"ArnLike": {\n      \t  "aws:SourceArn": "arn:aws:s3:::PREFIX-orca-archive-versioned"\n      \t}\n      }\n    },\n    {\n      "Sid": "Inventory-PREFIX-orca-archive-worm",\n      "Effect": "Allow",\n      "Principal": {\n        "Service": "s3.amazonaws.com"\n      },\n      "Action": "s3:PutObject",\n      "Resource": "arn:aws:s3:::PREFIX-orca-archive-worm/*",\n      "Condition": {\n        "StringEquals": {\n      \t  "aws:SourceAccount": "000000000000"\n        },\n      \t"ArnLike": {\n      \t  "aws:SourceArn": "arn:aws:s3:::PREFIX-orca-archive-worm"\n      \t}\n      }\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(t.p,{children:"The Principal value is the AWS root user for your Cumulus application that will\naccess the ORCA archive bucket."}),"\n",(0,s.jsxs)(t.p,{children:["Replace the number in ",(0,s.jsx)(t.code,{children:"arn:aws:iam::012345678912:root"})," with the value of your account number."]}),"\n",(0,s.jsxs)(t.p,{children:["Replace the number ",(0,s.jsx)(t.code,{children:"000000000000"})," with your DR account number."]}),"\n",(0,s.jsxs)(t.p,{children:["The Resource value is the bucket and bucket paths that the Cumulus application\ncan access. Replace ",(0,s.jsx)(t.code,{children:"PREFIX-orca-archive-versioned"})," with the name\nof the Orca archive bucket created in the ",(0,s.jsx)(t.a,{href:"#versioned-archive-bucket",children:"Versioned Archive Bucket"})," section."]}),"\n",(0,s.jsxs)(t.p,{children:["It may be possible to combine the two ",(0,s.jsx)(t.code,{children:"Inventory-PREFIX-orca-archive-*"})," rules, but this has not yet been tested."]}),"\n",(0,s.jsxs)(t.p,{children:["The ",(0,s.jsx)(t.a,{href:"https://aws.amazon.com/s3/storage-classes/",children:"storage class"})," should likely be modified to reduce costs associated with storing reports.\nMore research is needed, as the cost of downloading data goes up as the cost of storage goes down."]}),"\n",(0,s.jsxs)(t.p,{children:["A lifecycle rule should be created to delete reports after a certain amount of time, tentatively placed at 30 days.\nInstructions on creating this through TF can be found in the ",(0,s.jsx)(t.a,{href:"https://registry.terraform.io/providers/hashicorp/aws/3.63.0/docs/resources/s3_bucket",children:"official docs"}),".\nA Jira card for this ",(0,s.jsx)(t.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-451",children:"currently exists"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["We should also remove the ACL capabilities due to AWS potential deprecation.\nThis will be detailed in a ",(0,s.jsx)(t.a,{href:"#acl-rule-replacement",children:"future section"}),"."]}),"\n",(0,s.jsx)(t.h2,{id:"automation",children:"Automation"}),"\n",(0,s.jsx)(t.p,{children:"It would be ideal to have a Terraform (TF) module that handles bucket creation/updates.\nUnfortunately, since our deployment presently targets an account different from the Disaster Recovery account, this must be a separate TF deployment.\nThis will require the buckets to be recreated, so this will also require code to copy data from the old buckets to the new.\nThis will only need to be run once for switching from manual setup to TF setup, and will also help with cases where updates require buckets to be recreated."}),"\n",(0,s.jsxs)(t.p,{children:["A ",(0,s.jsx)(t.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-369",children:"Jira task"})," has been created to implement this feature."]}),"\n",(0,s.jsx)(t.h2,{id:"acl-rule-replacement",children:"ACL Rule Replacement"}),"\n",(0,s.jsxs)(t.p,{children:["Due to AWS suggesting that they will deprecate ACL rules, we should research a replacement for current ACL functionality.\nPresently ACL is used primarily to allow ORCA full ownership over files uploaded to S3, via the addition of ",(0,s.jsx)(t.code,{children:'"ACL": "bucket-owner-full-control"'})," when uploading via ",(0,s.jsx)(t.code,{children:"copy_to_archive"}),".\nBuckets with ACL rules disabled default to objects being owned by the bucket, so this may be a clean switch.\nAdditional research and testing should be conducted.\nA ",(0,s.jsx)(t.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-450",children:"Jira task"})," has been created to implement this switch."]})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>i});var s=n(6540);const r={},o=s.createContext(r);function a(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);
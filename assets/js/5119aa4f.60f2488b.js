"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[9695],{8321:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>l,toc:()=>a});var r=t(4848),i=t(8453);const s={id:"postgres-tips",title:"Postgres Paging",description:"Tips on writing efficient Postgres queries."},o=void 0,l={id:"developer/development-guide/code/postgres-tips",title:"Postgres Paging",description:"Tips on writing efficient Postgres queries.",source:"@site/docs/developer/development-guide/code/postgres-tips.md",sourceDirName:"developer/development-guide/code",slug:"/developer/development-guide/code/postgres-tips",permalink:"/cumulus-orca/docs/developer/development-guide/code/postgres-tips",draft:!1,unlisted:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/development-guide/code/postgres-tips.md",tags:[],version:"current",frontMatter:{id:"postgres-tips",title:"Postgres Paging",description:"Tips on writing efficient Postgres queries."},sidebar:"dev_guide",previous:{title:"Parallel Scripting",permalink:"/cumulus-orca/docs/developer/development-guide/code/parallel-scripting"},next:{title:"Documentation Introduction",permalink:"/cumulus-orca/docs/developer/development-guide/documentation/contrib-documentation-intro"}},d={},a=[{value:"Limit",id:"limit",level:2},{value:"Paging",id:"paging",level:2},{value:"Sample Table",id:"sample-table",level:3},{value:"Page Retrieval",id:"page-retrieval",level:3},{value:"Next Page (Default)",id:"next-page-default",level:4},{value:"Previous Page",id:"previous-page",level:4},{value:"Cursors",id:"cursors",level:3},{value:"No Cursor",id:"no-cursor",level:4}];function c(e){const n={code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"limit",children:"Limit"}),"\n",(0,r.jsxs)(n.p,{children:["Users may wish to adjust the number of results they receive to adjust memory usage, processing time, etc.\nIdeally this ",(0,r.jsx)(n.code,{children:"limit"})," value would have an upper bound, to avoid users requesting far too much data at once.\nHowever, in the particular case of GraphQL, users may request varying amounts of properties on their data, making an upper limit difficult to calculate for a given query."]}),"\n",(0,r.jsx)(n.h2,{id:"paging",children:"Paging"}),"\n",(0,r.jsx)(n.p,{children:"It will not always be feasible/desired to return all results at once.\nIn this case, results should be returned one 'page' at a time, with cursors included to allow customers to easily request the next page."}),"\n",(0,r.jsx)(n.h3,{id:"sample-table",children:"Sample Table"}),"\n",(0,r.jsx)(n.p,{children:"Code in the following sections will be based off of the following table:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:'CREATE TABLE "orca"."test_table"  ( \n    "key0"    int4 NULL,\n    "key1"    int4 NULL,\n    "key2"    int4 NULL \n    )\nGO\nALTER TABLE "orca"."test_table"\n    ADD CONSTRAINT "test_uniqueness"\n    UNIQUE ("key0", "key1", "key2")\n'})}),"\n",(0,r.jsx)(n.p,{children:"Adjust code as needed to match your table."}),"\n",(0,r.jsx)(n.p,{children:"If you wish to do performance testing with the sample table, run the following code:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"do $$\nbegin\n    for i in 1..100 loop\n        for j in 1..100 loop\n            for k in 1..100 loop\n                INSERT INTO orca.test_table(key0, key1, key2) VALUES(i, j, 'k);\n            end loop;\n        end loop;\n    end loop;\nend; $$\n"})}),"\n",(0,r.jsx)(n.h3,{id:"page-retrieval",children:"Page Retrieval"}),"\n",(0,r.jsxs)(n.p,{children:["The initial impulse for retrieving a page may be to ",(0,r.jsx)(n.code,{children:"SKIP"})," the number of entries from previous pages, utilizing ",(0,r.jsx)(n.code,{children:"LIMIT"})," and ",(0,r.jsx)(n.code,{children:"OFFSET"})," like the following:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"SELECT\n    *\nFROM\n    orca.test_table\nORDER BY \n    key0,\n    Key1,\n    key2\nLIMIT 100\nOFFSET 20000\n"})}),"\n",(0,r.jsxs)(n.p,{children:["However, this requires the query to process all of the entries that are not returned due to the ",(0,r.jsx)(n.code,{children:"OFFSET"}),", and is therefore non-performant on large datasets."]}),"\n",(0,r.jsxs)(n.p,{children:["A better option is to apply a ",(0,r.jsx)(n.code,{children:"WHERE"})," clause that picks up after the previous query.\nWhen applied via indexed columns, this eliminates the need for the database to process elements that are outside of the requested page, drastically improving the performance of the query on large datasets.\nIn the examples below, assume that the row we will be paging from is ",(0,r.jsx)(n.code,{children:"key0: 50, key1: 98, key2: 60"})]}),"\n",(0,r.jsx)(n.h4,{id:"next-page-default",children:"Next Page (Default)"}),"\n",(0,r.jsxs)(n.p,{children:["Retrieving the next page of ",(0,r.jsx)(n.code,{children:"limit"})," 100 would look like:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"SELECT\n    * \nFROM\n    orca.test_table\nWHERE\n    key0 >= 50\n    AND\n        (key0 > 50\n        OR\n            (key1 >= 98\n            AND\n                (key1 > 98\n                OR\n                    (key2 > 60)\n                )\n            )\n        )\nORDER BY \n    key0 ASC, \n\tkey1 ASC, \n\tkey2 ASC\nLIMIT 100\n"})}),"\n",(0,r.jsx)(n.p,{children:"Which will return data in the format:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"key0     key1     key2    \n-------  -------  ------- \n50       98       61      \n50       98       62\n50       98       63\n  ... TRUNCATED ...\n50       99       58      \n50       99       59 \n50       99       60 \n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note that the order of the keys in the ",(0,r.jsx)(n.code,{children:"WHERE"})," and ",(0,r.jsx)(n.code,{children:"ORDER BY"})," clauses must be identical in this example.\nThe filter should eliminate all of the previously retrieved rows."]}),"\n",(0,r.jsx)(n.h4,{id:"previous-page",children:"Previous Page"}),"\n",(0,r.jsxs)(n.p,{children:["In the event the user requests the previous page, modify the default query by flipping the signs and ",(0,r.jsx)(n.code,{children:"ORDER"}),", then reversing the ",(0,r.jsx)(n.code,{children:"ORDER"})," of results."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"SELECT\n\t* \nFROM\n\torca.test_table\nWHERE\n\tkey0 <= 50\n\tAND\n\t\t(key0 < 50\n\t\tOR\n\t\t\t(key1 <= 98\n\t\t\tAND\n\t\t\t\t(key1 < 98\n\t\t\t\tOR\n\t\t\t\t\t(key2 < 60)\n\t\t\t\t)\n\t\t\t)\n\t\t)\nORDER BY \n\tkey0 DESC, \n\tkey1 DESC, \n\tkey2 DESC\nLIMIT 100\n"})}),"\n",(0,r.jsx)(n.p,{children:"Once the results are reversed, data will be in the format:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"key0     key1     key2    \n-------  -------  ------- \n50       97       60      \n50       97       62\n50       97       63\n  ... TRUNCATED ...\n50       98       57  \n50       98       58      \n50       98       59 \n"})}),"\n",(0,r.jsx)(n.h3,{id:"cursors",children:"Cursors"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"decode_cursor"})," and ",(0,r.jsx)(n.code,{children:"encode_cursor"})," in the graphql project can be used to encode and decode arbitrary dictionaries for use in future queries.\nIn our example table, this would consist of ",(0,r.jsx)(n.code,{children:"key0"}),", ",(0,r.jsx)(n.code,{children:"key1"}),", and ",(0,r.jsx)(n.code,{children:"key2"})," to be able to enforce paging uniqueness.\nThese cursors point to individual elements.\nAt minimum, users should be given a ",(0,r.jsx)(n.code,{children:"start_cursor"})," and an ",(0,r.jsx)(n.code,{children:"end_cursor"})," for any page they retrieve.\nThe customer can then make a request with ",(0,r.jsx)(n.code,{children:"cursor: {their end_cursor}, direction: 'next', limit: 100"})," to get the page past the end_cursor,\nor ",(0,r.jsx)(n.code,{children:"cursor: {their start_cursor}, direction: 'previous', limit: 100"})," to get the page before the start_cursor."]}),"\n",(0,r.jsx)(n.h4,{id:"no-cursor",children:"No Cursor"}),"\n",(0,r.jsxs)(n.p,{children:["If no cursor is specified, behavior depends on ",(0,r.jsx)(n.code,{children:"direction"}),"."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"direction"})," is ",(0,r.jsx)(n.code,{children:"next"}),", get the first page of results using standard ordering."]}),"\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"direction"})," is ",(0,r.jsx)(n.code,{children:"previous"}),", get the last page of results using inverted ordering.\nThis allows users to retrieve either the first or last page of results, effectively allowing them to begin at the start or end of the record-set and page from there.\nThis is particularly helpful in cases where the query is ordered by date, and users may want to look at events in chronological order, or may only want to look at the most recent events."]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var r=t(6540);const i={},s=r.createContext(i);function o(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);
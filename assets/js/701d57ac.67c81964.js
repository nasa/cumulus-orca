"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[2445],{3310:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"developer/research/research-bamboo-integration-tests","title":"Research Notes on running integration tests in bamboo CI/CD","description":"Research Notes on deploying Cumulus and ORCA in bamboo CI/CD and running integration tests.","source":"@site/docs/developer/research/research-bamboo-integration-tests.md","sourceDirName":"developer/research","slug":"/developer/research/research-bamboo-integration-tests","permalink":"/cumulus-orca/docs/developer/research/research-bamboo-integration-tests","draft":false,"unlisted":false,"editUrl":"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/research/research-bamboo-integration-tests.md","tags":[],"version":"current","frontMatter":{"id":"research-bamboo-integration-tests","title":"Research Notes on running integration tests in bamboo CI/CD","description":"Research Notes on deploying Cumulus and ORCA in bamboo CI/CD and running integration tests."},"sidebar":"dev_guide","previous":{"title":"Research Notes on ORCA delete functionality.","permalink":"/cumulus-orca/docs/developer/research/research-orca-delete-functionality"},"next":{"title":"Using Lambda functions as container research Notes","permalink":"/cumulus-orca/docs/developer/research/research-lambda-container"}}');var t=n(4848),s=n(8453);const r={id:"research-bamboo-integration-tests",title:"Research Notes on running integration tests in bamboo CI/CD",description:"Research Notes on deploying Cumulus and ORCA in bamboo CI/CD and running integration tests."},i=void 0,c={},l=[{value:"Deploying terraform modules via bamboo",id:"deploying-terraform-modules-via-bamboo",level:2},{value:"Future directions",id:"future-directions",level:2},{value:"References",id:"references",level:5}];function d(e){const o={a:"a",admonition:"admonition",code:"code",h2:"h2",h5:"h5",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(o.h2,{id:"deploying-terraform-modules-via-bamboo",children:"Deploying terraform modules via bamboo"}),"\n",(0,t.jsx)(o.p,{children:"AWS resources can be deployed via Bamboo pipeline by first adding the following to a script and running that in a Bamboo task."}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"#configure aws\nexport AWS_ACCESS_KEY_ID=$bamboo_AWS_ACCESS_KEY_ID\nexport AWS_SECRET_ACCESS_KEY=$bamboo_AWS_SECRET_ACCESS_KEY\nexport AWS_DEFAULT_REGION=$bamboo_AWS_DEFAULT_REGION\n"})}),"\n",(0,t.jsx)(o.admonition,{type:"note",children:(0,t.jsxs)(o.p,{children:["In order to use a user-defined bamboo environment variable inside a script, ",(0,t.jsx)(o.code,{children:"$bamboo_"})," must be added as a prefix to the variable. For example, use ",(0,t.jsx)(o.code,{children:"$bamboo_AWS_DEFAULT_REGION"})," in your script to use the variable AWS_DEFAULT_REGION."]})}),"\n",(0,t.jsxs)(o.p,{children:["Details of some of the initial work done are added in the ",(0,t.jsx)(o.a,{href:"https://github.com/nasa/cumulus-orca/tree/feature/ORCA-test-bamboo",children:"ORCA-test-bamboo"})," branch of ",(0,t.jsx)(o.code,{children:"cumulus-orca"})," repo.\nThe ",(0,t.jsx)(o.a,{href:"https://github.com/nasa/cumulus-orca/blob/feature/ORCA-test-bamboo/bamboo-specs/bamboo.yaml#L22",children:"bamboo spec file"})," has been modified to add two new stages named ",(0,t.jsx)(o.code,{children:"Deploy Dev RDS Stack"})," stage which deploys the RDS cluster in sandbox and the ",(0,t.jsx)(o.code,{children:"Deploy Dev Cumulus and ORCA Stack"})," stage which deploys the data persistence module as well as cumulus and orca modules. The stages in bamboo spec are shown below."]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-yaml",children:"#deploy RDS cluster for integration test\n- Deploy Dev RDS Stack:\n    manual: true\n    final: false\n    jobs:\n    - Deploy RDS cluster\n\n#deploy orca and cumulus for integration test\n- Deploy Dev Cumulus and ORCA Stack:\n    manual: true\n    final: false\n    jobs:\n    - Deploy cumulus and orca\n"})}),"\n",(0,t.jsxs)(o.p,{children:["The ",(0,t.jsx)(o.a,{href:"https://github.com/nasa/cumulus-orca/blob/feature/ORCA-test-bamboo/bin/deployment-rds.sh",children:(0,t.jsx)(o.code,{children:"deployment-rds.sh"})})," script is an initial working script that was used to deploy the RDS cluster. The ",(0,t.jsx)(o.a,{href:"https://github.com/nasa/cumulus-orca/blob/feature/ORCA-test-bamboo/bin/deployment-cumulus-orca.sh",children:(0,t.jsx)(o.code,{children:"deployment-cumulus-orca.sh"})})," script was used to deploy the data-persistence-tf module. Some changes still need to be made in these scripts to make it more functional and handle errors. A successful bamboo build can be seen ",(0,t.jsx)(o.a,{href:"https://ci.earthdata.nasa.gov/browse/ORCA-PP-108",children:"here"}),".\nA snippet of the script to deploy RDS cluster via terraform is shown below."]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:'# Deploy drds-cluster-tf via terraform\necho "Deploying rds-cluster-tf  module to $bamboo_DEPLOYMENT"\nterraform apply \\\n  -auto-approve \\\n  -lock=false \\\n  -input=false \\\n  -var-file="terraform.tfvars" \\\n  -var "prefix=$bamboo_PREFIX" \\\n  -var "region=$bamboo_AWS_DEFAULT_REGION" \\\n  -var "subnets=[\\"$bamboo_AWS_SUBNET_ID1\\", \\"$bamboo_AWS_SUBNET_ID2\\"]" \\\n  -var "db_admin_username=$bamboo_DB_ADMIN_USERNAME" \\\n  -var "db_admin_password=$bamboo_DB_ADMIN_PASSWORD" \\\n  -var "vpc_id=$bamboo_VPC_ID" \\\n  -var "cluster_identifier=$bamboo_RDS_CLUSTER_ID" \\\n  -var "deletion_protection=false"\\\n  -var "provision_user_database=false"\\\n  -var "engine_version=10.14"\\\n  -var "permissions_boundary_arn=arn:aws:iam::$bamboo_AWS_ACCOUNT_ID:policy/$bamboo_ROLE_BOUNDARY"\n'})}),"\n",(0,t.jsxs)(o.p,{children:["Variables in terraform.tfvars can be overwritten by the ",(0,t.jsx)(o.code,{children:"-var"})," field as seen above."]}),"\n",(0,t.jsxs)(o.p,{children:["Some of the sensitive bamboo variables such as ",(0,t.jsx)(o.code,{children:"AWS_ACCESS_KEY_ID"}),", ",(0,t.jsx)(o.code,{children:"AWS_SECRET_ACCESS_KEY"}),", have been encrypted using bamboo encryption service. While running the pipeline, those variables have to be replaced manually with the real values since bamboo does not automatically decrypt the values while running the pipeline. Make sure all sensitive variables are encrypted before pushing the changes to the repo."]}),"\n",(0,t.jsx)(o.p,{children:"The bamboo spec for running the two scripts under tasks is shown below."}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-yaml",children:"#job for deploying cumulus and orca\nDeploy RDS cluster:\n  key: DRC\n  other:\n    clean-working-dir: true\n    # Some plugin configurations are not supported by YAML Specs\n  docker:\n    image: amazonlinux:2\n    volumes:\n      ${bamboo.working.directory}: ${bamboo.working.directory}\n      ${bamboo.tmp.directory}: ${bamboo.tmp.directory}\n  tasks:\n  - checkout:\n      force-clean-build: 'true'\n      description: Checkout Default Repository\n\n  - script:\n      interpreter: SHELL\n      scripts:\n      - |-\n        #!/bin/bash\n        chmod +x bin/deployment-rds.sh\n        bin/deployment-rds.sh\n#job for deploying cumulus and orca\nDeploy cumulus and orca:\n  key: DCO\n  other:\n    clean-working-dir: true\n    # Some plugin configurations are not supported by YAML Specs\n  docker:\n    image: amazonlinux:2\n    volumes:\n      ${bamboo.working.directory}: ${bamboo.working.directory}\n      ${bamboo.tmp.directory}: ${bamboo.tmp.directory}\n  tasks:\n  - checkout:\n      force-clean-build: 'true'\n      description: Checkout Default Repository\n\n  - script:\n      interpreter: SHELL\n      scripts:\n      - |-\n        #!/bin/bash\n        chmod +x bin/deployment-cumulus-orca.sh\n        bin/deployment-cumulus-orca.sh\n"})}),"\n",(0,t.jsx)(o.h2,{id:"future-directions",children:"Future directions"}),"\n",(0,t.jsxs)(o.p,{children:["The first step will be to finish deploying all cumulus tf modules via Bamboo into sandbox account. Once that is completed, automation scripts for running the integrations tests need to be created. The original plan ",(0,t.jsx)(o.code,{children:"ORCA Integrator"})," in bamboo will need to be updated with the same changes made in ",(0,t.jsx)(o.code,{children:"prototype-demo"})," plan's ",(0,t.jsx)(o.code,{children:"feature/ORCA-test-bamboo"})," branch so that the ",(0,t.jsx)(o.code,{children:"develop"})," branch is updated. In addition, older resources should be deleted from AWS once tests are validated."]}),"\n",(0,t.jsxs)(o.p,{children:["The details of the DockerFile as well as the scripts currently used by GHRC to deploy their repository to Bamboo CI/CD can be found ",(0,t.jsx)(o.a,{href:"https://github.com/ghrcdaac/GHRC-TF-CICD",children:"here"})," which will be useful to look into later on. Moreover, the environment variables in bamboo can be exported using env files to better manage terraform variables needed for deployment. See ",(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-393",children:"ORCA-393"})," for more information on this."]}),"\n",(0,t.jsx)(o.p,{children:"Some of the cards created to finish the task include:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-388-",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-388-"})," Create Docker image for running ORCA integration tests"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-389-",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-389-"})," Finish up the remaining work on deploying cumulus-tf module in bamboo. Update ORCA-integrator plan in bamboo."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-390-",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-390-"})," Cleanup deployment of old integration test files/resources from bamboo"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-391-",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-391-"})," Research and create a list of integration tests needed for ORCA once all tf modules are deployed and successful"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-392-",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-392-"})," Create the actual integration test scripts for bamboo."]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://bugs.earthdata.nasa.gov/browse/ORCA-393-",children:"https://bugs.earthdata.nasa.gov/browse/ORCA-393-"})," Convert bamboo env variables to a script."]}),"\n"]}),"\n",(0,t.jsx)(o.h5,{id:"references",children:"References"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"https://github.com/nasa/cumulus/tree/master/bamboo",children:"https://github.com/nasa/cumulus/tree/master/bamboo"})}),"\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"https://github.com/nasa/cumulus/blob/master/bamboo/bootstrap-tf-deployment.sh",children:"https://github.com/nasa/cumulus/blob/master/bamboo/bootstrap-tf-deployment.sh"})}),"\n",(0,t.jsx)(o.li,{children:(0,t.jsx)(o.a,{href:"https://github.com/ghrcdaac/GHRC-TF-CICD",children:"https://github.com/ghrcdaac/GHRC-TF-CICD"})}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.a,{href:"https://eosdis.slack.com/archives/C76M787MZ/p1646247174655179",children:"https://eosdis.slack.com/archives/C76M787MZ/p1646247174655179"})," (chat history with cumulus on some of the issues faced during deployment)"]}),"\n"]})]})}function h(e={}){const{wrapper:o}={...(0,s.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,o,n)=>{n.d(o,{R:()=>r,x:()=>i});var a=n(6540);const t={},s=a.createContext(t);function r(e){const o=a.useContext(s);return a.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function i(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),a.createElement(s.Provider,{value:o},e.children)}}}]);